<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ø§Ù„Ù†Ø®Ø¨Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±ÙŠØ© â€” Ù…Ù†ØµØ© Ø§Ø­ØªØ±Ø§ÙÙŠØ© Ù„Ù„Ø¨ÙŠØ¹</title>
  <meta name="description" content="Ù…Ù†ØµØ© Ø§Ù„Ù†Ø®Ø¨Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±ÙŠØ© - Ø¨ÙŠØ¹ Ø¹Ù‚Ø§Ø±Ø§Øª ÙÙŠ Ø§Ù„Ø·Ø§Ø¦Ù. ØªÙˆØ§ØµÙ„ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨ Ù…Ø¨Ø§Ø´Ø±Ø© Ù…Ø¹ Ø§Ù„ÙˆØ³ÙŠØ· Ø£Ùˆ Ø§Ù„Ù…Ø¯ÙŠØ±."/>
  <style>
    /* ---------- Design system (modern, RTL, professional) ---------- */
    :root{
      --bg:#f6f8fb;
      --card:#ffffff;
      --muted:#6b7280;
      --accent:#0754d1;
      --accent-2:#0b87ff;
      --glass: rgba(255,255,255,0.7);
      --danger:#ef4444;
      --radius:14px;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", "Noto Sans Arabic", "Arial";
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background: linear-gradient(180deg, #f3f7ff 0%, var(--bg) 100%);
      color:#0f172a;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      line-height:1.45;
    }
    a{color:inherit;text-decoration:none}
    header{
      position:sticky;top:0;z-index:60;
      backdrop-filter: blur(6px);
      background: linear-gradient(90deg, rgba(255,255,255,0.9), rgba(250,250,255,0.7));
      border-bottom:1px solid rgba(15,23,42,0.04);
      display:flex;align-items:center;gap:18px;padding:14px 20px;
    }
    .container{max-width:1200px;margin:18px auto;padding:0 18px}
    .logo{display:flex;align-items:center;gap:12px}
    .logo img{width:58px;height:58px;border-radius:12px;object-fit:cover;box-shadow:0 6px 20px rgba(11,108,245,0.08)}
    .title{font-weight:800;font-size:18px}
    .subtitle{font-size:12px;color:var(--muted)}
    .top-actions{margin-left:auto;display:flex;gap:10px;align-items:center}

    /* buttons */
    .btn{
      display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:12px;
      background:var(--accent);color:white;border:0;cursor:pointer;font-weight:700;
      box-shadow:0 8px 22px rgba(11,108,245,0.08);
    }
    .btn.ghost{background:transparent;color:var(--accent);border:1px solid rgba(11,108,245,0.12);box-shadow:none}
    .btn.small{padding:8px 10px;border-radius:10px;font-weight:600}

    /* hero/search */
    .hero{display:flex;align-items:center;justify-content:space-between;gap:18px;margin-top:18px}
    .hero-card{flex:1;background:linear-gradient(180deg,#ffffff,#f8fbff);padding:18px;border-radius:16px;box-shadow:0 12px 40px rgba(2,6,23,0.06)}
    .search-row{display:flex;gap:10px;align-items:center}
    .search-row input, .search-row select{flex:1;padding:12px;border-radius:12px;border:1px solid #e9eef8;font-size:15px}
    .search-row input::placeholder{color:#9aa4c4}

    /* categories */
    .cats{display:flex;gap:12px;margin-top:14px;flex-wrap:wrap}
    .cat{
      display:flex;align-items:center;gap:10px;padding:10px 14px;border-radius:12px;background:linear-gradient(180deg,#fff,#fbfdff);
      box-shadow:0 6px 18px rgba(2,6,23,0.04);cursor:pointer;border:1px solid rgba(11,108,245,0.03);font-weight:700
    }

    /* layout */
    .grid{display:grid;grid-template-columns:1fr 360px;gap:20px;margin-top:20px}
    .main-col{min-height:300px}
    .aside{position:relative}

    /* cards */
    .cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:18px}
    .card{
      background:var(--card);border-radius:12px;overflow:hidden;display:flex;flex-direction:column;transition:transform .18s, box-shadow .18s;
      box-shadow:0 8px 28px rgba(2,6,23,0.06);
    }
    .card:hover{transform:translateY(-8px);box-shadow:0 18px 48px rgba(2,6,23,0.09)}
    .card .thumb{height:170px;background:linear-gradient(90deg,#eef6ff,#f6f9ff);display:flex;align-items:center;justify-content:center}
    .card img{width:100%;height:100%;object-fit:cover}
    .card .body{padding:12px;display:flex;flex-direction:column;gap:8px}
    .card .row{display:flex;justify-content:space-between;align-items:center}
    .price{color:var(--accent);font-weight:900}
    .meta{color:var(--muted);font-size:13px}

    .card .actions{display:flex;gap:8px;padding:12px;border-top:1px solid #f3f6fb}
    .pill{background:#f1f7ff;color:var(--accent);padding:6px 10px;border-radius:10px;font-weight:700;font-size:13px}

    /* detail */
    .detail{padding:14px;border-radius:12px;background:linear-gradient(180deg,#fff,#fbfdff);box-shadow:0 12px 36px rgba(2,6,23,0.06)}
    .detail .gallery{display:flex;gap:8px;overflow:auto;padding-bottom:6px}
    .detail img{height:160px;border-radius:10px;object-fit:cover}
    .detail table{width:100%;border-collapse:collapse;margin-top:12px}
    .detail th, .detail td{padding:8px;text-align:right;border-bottom:1px dashed #eef2fb;color:#334155}

    /* forms */
    form .row{display:flex;gap:10px}
    label{font-weight:700;color:#111827;margin-bottom:6px;display:block}
    input[type=file]{padding:6px}

    /* floating whatsapp */
    .wh-float{position:fixed;left:18px;bottom:18px;background:linear-gradient(90deg,var(--accent),var(--accent-2));color:white;padding:12px 14px;border-radius:14px;box-shadow:0 12px 30px rgba(11,108,245,0.18);display:flex;gap:10px;align-items:center;z-index:80}

    footer{text-align:center;color:var(--muted);margin:28px 0}

    /* responsive */
    @media(max-width:980px){
      .grid{grid-template-columns:1fr}
      .hero{flex-direction:column;align-items:stretch}
      .top-actions{display:none}
      .wh-float{left:12px;right:12px;justify-content:center}
    }
  </style>
</head>
<body>

  <header>
    <div class="container" style="display:flex;align-items:center;gap:14px;">
      <div class="logo">
        <img id="logo-preview" src="" alt="logo"/>
        <div>
          <div class="title">Ø§Ù„Ù†Ø®Ø¨Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±ÙŠØ©</div>
          <div class="subtitle">Ù…Ù†ØµØ© Ø§Ø­ØªØ±Ø§ÙÙŠØ© Ù„Ù„Ø¨ÙŠØ¹ â€” ØªÙˆØ§ØµÙ„ Ù…Ø¨Ø§Ø´Ø± Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨</div>
        </div>
      </div>

      <div class="top-actions">
        <button class="btn ghost" id="btn-home">Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
        <button class="btn" id="btn-login-open">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
      </div>
    </div>
  </header>

  <main class="container">
    <!-- HERO + SEARCH -->
    <section class="hero">
      <div class="hero-card">
        <h2 style="margin:0 0 6px 0">Ø§Ø¨Ø­Ø« Ø¹Ù† Ø¹Ù‚Ø§Ø±Ùƒ Ø§Ù„Ù‚Ø§Ø¯Ù…</h2>
        <p style="margin:0 0 12px 0;color:var(--muted)">Ø§Ø¨Ø­Ø« Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹ØŒ Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø£Ùˆ Ø§Ù„Ø³Ø¹Ø± â€” Ùˆ ØªÙˆØ§ØµÙ„ Ù…Ø¨Ø§Ø´Ø±Ø© Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨.</p>

        <div class="search-row" style="margin-bottom:8px">
          <input id="q" placeholder="Ù…Ø«Ø§Ù„: ÙÙŠÙ„Ø§ ÙØ§Ø®Ø±Ø© Ø£Ùˆ Ø§Ù„Ø­ÙˆÙŠØ©" />
          <select id="filter-type">
            <option value="">ÙƒÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</option>
            <option>Ø¹Ù…Ø§Ø±Ø©</option><option>ÙÙŠÙ„Ø§</option><option>Ø´Ù‚Ø©</option><option>Ø£Ø±Ø¶</option><option>Ø§Ø³ØªØ±Ø§Ø­Ø©</option>
          </select>
          <select id="filter-region">
            <option value="">ÙƒÙ„ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚</option>
            <option>Ø´Ù…Ø§Ù„ Ø§Ù„Ø·Ø§Ø¦Ù</option><option>Ø¬Ù†ÙˆØ¨ Ø§Ù„Ø·Ø§Ø¦Ù</option><option>Ø´Ø±Ù‚ Ø§Ù„Ø·Ø§Ø¦Ù</option><option>ØºØ±Ø¨ Ø§Ù„Ø·Ø§Ø¦Ù</option>
          </select>
          <button class="btn" id="btn-search">Ø§Ø¨Ø­Ø«</button>
        </div>

        <div class="cats" aria-hidden>
          <div class="cat" data-type="ÙÙŠÙ„Ø§">ğŸ¡ ÙÙŠÙ„Ø§</div>
          <div class="cat" data-type="Ø´Ù‚Ø©">ğŸ˜ Ø´Ù‚Ø©</div>
          <div class="cat" data-type="Ø¹Ù…Ø§Ø±Ø©">ğŸ¢ Ø¹Ù…Ø§Ø±Ø©</div>
          <div class="cat" data-type="Ø£Ø±Ø¶">ğŸŸ© Ø£Ø±Ø¶</div>
          <div class="cat" data-type="Ø§Ø³ØªØ±Ø§Ø­Ø©">ğŸŒ´ Ø§Ø³ØªØ±Ø§Ø­Ø©</div>
        </div>
      </div>

      <aside style="width:360px">
        <div class="detail">
          <h3 style="margin-top:0">Ù„Ù… Ø£Ø¬Ø¯ Ø§Ù„Ø¹Ù‚Ø§Ø± Ø§Ù„Ù…Ù†Ø§Ø³Ø¨ØŸ</h3>
          <p style="color:var(--muted);margin:6px 0 10px 0">Ø§Ø¶ØºØ· Ø§Ù„Ø²Ø± ÙˆØ³ÙŠØªÙ… ØªÙˆØ¬ÙŠÙ‡Ùƒ Ù„Ù„Ù…Ø¯ÙŠØ± Ù…Ø¨Ø§Ø´Ø±Ø© Ø¹Ù„Ù‰ ÙˆØ§ØªØ³Ø§Ø¨.</p>
          <button class="btn" id="not-found">Ù„Ù… Ø£Ø¬Ø¯ Ø§Ù„Ø¹Ù‚Ø§Ø± Ø§Ù„Ù…Ù†Ø§Ø³Ø¨</button>

          <hr style="margin:12px 0;border:none;border-top:1px dashed #eef4ff">

          <h4 style="margin:8px 0">Ø§ØªØµÙ„ Ø¨Ø§Ù„Ù…Ø¯ÙŠØ±</h4>
          <p style="color:var(--muted);margin:6px 0">Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ: <b id="manager-number">0535342404</b></p>
        </div>
      </aside>
    </section>

    <!-- GRID: listings + sidebar -->
    <section class="grid">
      <section class="main-col">
        <div id="cards" class="cards" aria-live="polite"></div>
      </section>

      <aside class="aside">
        <div class="detail">
          <h4 style="margin-top:0">Ø£Ù‚Ø³Ø§Ù… Ø³Ø±ÙŠØ¹Ø©</h4>
          <div style="display:flex;flex-direction:column;gap:8px;margin-top:10px">
            <div class="cat" data-type="ÙÙŠÙ„Ø§">ğŸ¡ ÙÙŠÙ„Ø§</div>
            <div class="cat" data-type="Ø´Ù‚Ø©">ğŸ˜ Ø´Ù‚Ø©</div>
            <div class="cat" data-type="Ø£Ø±Ø¶">ğŸŸ© Ø£Ø±Ø¶</div>
            <div class="cat" data-type="Ø¹Ù…Ø§Ø±Ø©">ğŸ¢ Ø¹Ù…Ø§Ø±Ø©</div>
          </div>
          <hr style="margin:12px 0;border:none;border-top:1px dashed #eef4ff">
          <h5>Ù„ÙˆØ­Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„</h5>
          <p style="color:var(--muted);margin:6px 0 10px 0">Ø§Ø®ØªØ¨Ø± Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ù„ÙŠÙˆØ²Ø± Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ: <b>IVL511</b></p>
          <button class="btn small" id="open-login-2">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
        </div>
      </aside>
    </section>

    <!-- detail modal / page (rendered via JS) -->
    <section id="detail-view" style="display:none;margin-top:18px">
      <div class="detail">
        <div style="display:flex;justify-content:space-between;align-items:start">
          <div>
            <h3 id="detail-title" style="margin:0"></h3>
            <div class="meta" id="detail-region"></div>
          </div>
          <div style="text-align:left">
            <div class="price" id="detail-price"></div>
            <div class="meta" id="detail-area"></div>
          </div>
        </div>

        <div class="gallery" id="detail-images" style="margin-top:12px"></div>
        <p id="detail-desc" style="margin-top:12px;color:#263248"></p>

        <table>
          <tbody>
            <tr><th>Ø§Ù„Ø­ÙŠ/Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</th><td id="detail-neighborhood"></td></tr>
            <tr><th>Ø§Ù„ØµÙƒ</th><td id="detail-sak"></td></tr>
            <tr><th>ÙŠÙ‚Ø¨Ù„ Ø§Ù„Ø¨Ù†Ùƒ</th><td id="detail-bank"></td></tr>
            <tr><th>Ø¹Ø±Ø¶ Ø¨ÙˆØ§Ø³Ø·Ø©</th><td id="detail-owner"></td></tr>
          </tbody>
        </table>

        <div style="display:flex;gap:10px;margin-top:12px">
          <button class="btn" id="contact-ws-detail">Ø§Ù„ØªÙˆØ§ØµÙ„ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨</button>
          <button class="btn ghost" id="back-to-results">Ø¹ÙˆØ¯Ø© Ù„Ù„Ø¨Ø­Ø«</button>
        </div>
      </div>
    </section>

    <footer>Â© Ø§Ù„Ù†Ø®Ø¨Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±ÙŠØ© â€” Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©</footer>
  </main>

  <!-- floating WhatsApp (always links to manager for 'not found') -->
  <div class="wh-float" id="wh-float" role="button" aria-label="Ø§ØªØµÙ„ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨">
    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" style="transform:scaleX(-1)"><path d="M21 12.05C21 6.48 16.52 2 11 2S1 6.48 1 12.05c0 2.1.6 4.06 1.69 5.73L1 23l5.5-1.44C8.05 22.04 9.5 22.5 11 22.5c5.52 0 10-4.48 10-10.45z" fill="white" opacity="0.12"/><path d="M17.4 14.9c-.28-.14-1.66-.82-1.92-.91-.26-.09-.45-.14-.64.14-.18.28-.72.91-.88 1.1-.16.18-.33.2-.61.07-.28-.14-1.18-.44-2.25-1.39-.83-.74-1.38-1.66-1.55-1.94-.16-.28-.02-.43.12-.57.13-.12.28-.33.42-.5.14-.18.19-.3.28-.5.09-.2.04-.36-.02-.5-.06-.14-.64-1.54-.88-2.12-.23-.55-.46-.47-.64-.48l-.54-.01c-.18 0-.5.07-.77.36-.27.29-1.04 1.01-1.04 2.46 0 1.45 1.07 2.86 1.22 3.06.15.2 2.1 3.38 5.09 4.74 2.99 1.36 3.35 1.23 3.95 1.15.6-.08 1.95-.79 2.22-1.55.27-.76.27-1.41.19-1.55-.07-.14-.26-.23-.54-.37z" fill="white"/></svg>
    <div style="font-weight:800">Ø§ØªØµÙ„ Ø¨Ø§Ù„Ù…Ø¯ÙŠØ±</div>
  </div>

  <!-- Firebase compat SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>

  <script>
    /*************** Firebase config (as provided) ***************/
    const firebaseConfig = {
      apiKey: "AIzaSyApEkbNuWz1nd0DSwt4lirlVlUSt3GNB0Y",
      authDomain: "alnokhbu.firebaseapp.com",
      projectId: "alnokhbu",
      storageBucket: "alnokhbu.firebasestorage.app",
      messagingSenderId: "647865484582",
      appId: "1:647865484582:web:162d57ee1dfab160c9ede7",
      measurementId: "G-GMZB6BG3LY"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const storage = firebase.storage();

    /*************** App state ***************/
    let managerWhats = '0535342404'; // override from settings doc
    let currentUser = null; // {id, username, role, whatsapp}
    let currentDetail = null;

    /*************** Helpers ***************/
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));
    function fmt(n){ return (n||'').toString().replace(/(\\d)(?=(\\d{3})+$)/g,'$1,'); }
    function normPhone(n){ return (n||'').toString().replace(/[^0-9]/g,''); }
    function esc(s){ return (s||'').toString().replace(/[&<>\"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;',\"'\":\"&#39;\"})[c]); }

    /*************** Init defaults (create admin/settings if missing) ***************/
    async function ensureDefaults(){
      // settings doc
      const setRef = db.collection('settings').doc('site');
      const setSnap = await setRef.get();
      if(!setSnap.exists){
        await setRef.set({managerWhats:'0535342404', logo:'', createdAt: firebase.firestore.FieldValue.serverTimestamp()});
        managerWhats = '0535342404';
      } else {
        const data = setSnap.data();
        managerWhats = data.managerWhats || '0535342404';
        if(data.logo) $('#logo-preview').src = data.logo;
      }
      $('#manager-number').innerText = managerWhats;

      // ensure admin user IVL511
      const q = await db.collection('users').where('username','==','IVL511').get();
      if(q.empty){
        await db.collection('users').add({username:'IVL511', password:'IVL511', role:'admin', active:true, whatsapp:managerWhats, createdAt: firebase.firestore.FieldValue.serverTimestamp()});
      }

      // add a sample prop if none exist
      const propsSnap = await db.collection('props').limit(1).get();
      if(propsSnap.empty){
        await db.collection('props').add({
          type:'ÙÙŠÙ„Ø§', title:'ÙÙŠÙ„Ø§ ÙØ§Ø®Ø±Ø© Ù„Ù„Ø¨ÙŠØ¹', price:'1500000', area:'500',
          region:'Ø´Ù…Ø§Ù„ Ø§Ù„Ø·Ø§Ø¦Ù', neighborhood:'Ø§Ù„Ø­ÙˆÙŠØ©', sak:true, bankAccepted:true,
          desc:'ÙÙŠÙ„Ø§ ÙØ§Ø®Ø±Ø© Ø¨Ù…ÙˆØ§ØµÙØ§Øª Ø¹Ø§Ù„ÙŠØ© ÙÙŠ Ù…ÙˆÙ‚Ø¹ Ù…Ù…ÙŠØ². ØªÙˆØ§ØµÙ„ Ù„Ù„Ù…Ø´Ø§Ù‡Ø¯Ø©.', images:[],
          ownerRole:'admin', ownerId:null, createdAt: firebase.firestore.FieldValue.serverTimestamp(), views:0
        });
      }
    }

    // run init then load UI
    ensureDefaults().then(()=>{ loadSettings(); loadCards(); });

    /*************** Load settings ***************/
    async function loadSettings(){
      const setSnap = await db.collection('settings').doc('site').get();
      const data = setSnap.exists ? setSnap.data() : null;
      if(data){
        managerWhats = data.managerWhats || managerWhats;
        $('#manager-number').innerText = managerWhats;
        if(data.logo) $('#logo-preview').src = data.logo;
      }
    }

    /*************** Render cards (public) ***************/
    async function loadCards(filter = {}){
      const snap = await db.collection('props').orderBy('createdAt','desc').get();
      const out = [];
      snap.forEach(d => out.push({id:d.id, ...d.data()}));
      // client-side filter
      const q = (filter.q||'').toString().toLowerCase();
      const filtered = out.filter(p=>{
        if(filter.type && filter.type !== p.type) return false;
        if(filter.region && filter.region !== p.region) return false;
        if(q && !((p.title||'').toLowerCase().includes(q) || (p.neighborhood||'').toLowerCase().includes(q) || (p.desc||'').toLowerCase().includes(q))) return false;
        return true;
      });

      const cards = $('#cards'); cards.innerHTML = '';
      if(filtered.length === 0){ cards.innerHTML = '<div style="padding:18px;background:#fff;border-radius:12px">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ø±ÙˆØ¶ Ø­Ø§Ù„ÙŠØ§Ù‹</div>'; return; }

      filtered.forEach(p=>{
        const img = (p.images && p.images.length) ? p.images[0] : '';
        const el = document.createElement('div'); el.className = 'card';
        el.innerHTML = `
          <div class="thumb">${ img ? `<img src="${esc(img)}" alt="${esc(p.title)}">` : '<div style="padding:12px;color:var(--muted)">ØµÙˆØ±Ø© Ù‚Ø§Ø¯Ù…Ø©</div>' }</div>
          <div class="body">
            <div class="row">
              <div>
                <div class="price">${fmt(p.price)} Ø±.Ø³</div>
                <div style="font-size:15px;font-weight:800">${esc(p.title)}</div>
              </div>
              <div style="text-align:left">
                <div class="pill">${esc(p.type||'')}</div>
                <div class="meta" style="margin-top:6px">${esc(p.region||'')}</div>
              </div>
            </div>
            <div class="meta">${esc(p.neighborhood||'')} â€¢ ${esc(p.area||'')} Ù…Â²</div>
          </div>
          <div class="actions">
            <button class="btn small detail-btn" data-id="${p.id}">Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„</button>
            <button class="btn small ghost contact-btn" data-id="${p.id}">ÙˆØ§ØªØ³Ø§Ø¨</button>
          </div>
        `;
        cards.appendChild(el);
      });

      // attach events
      $$('.detail-btn').forEach(b => b.addEventListener('click', e => showDetail(e.currentTarget.dataset.id)));
      $$('.contact-btn').forEach(b => b.addEventListener('click', e => contactFromCard(e.currentTarget.dataset.id)));
    }

    // search behavior
    $('#btn-search').addEventListener('click', ()=> loadCards({q:$('#q').value, type:$('#filter-type').value, region:$('#filter-region').value}));
    $$('.cat').forEach(c=>c.addEventListener('click', e => { const t = e.currentTarget.dataset.type; $('#filter-type').value = t; loadCards({type:t}); }));

    /*************** Detail view and contact logic ***************/
    async function showDetail(id){
      const doc = await db.collection('props').doc(id).get();
      if(!doc.exists) return alert('Ø§Ù„Ø¹Ø±Ø¶ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
      const p = {id:doc.id, ...doc.data()};
      // increment view count
      await db.collection('props').doc(id).update({views: (p.views||0)+1});
      currentDetail = p;

      $('#detail-title').innerText = p.title || '';
      $('#detail-region').innerText = p.region || '';
      $('#detail-price').innerText = fmt(p.price) + ' Ø±.Ø³';
      $('#detail-area').innerText = (p.area || '') + ' Ù…Â²';
      $('#detail-desc').innerText = p.desc || '';
      $('#detail-neighborhood').innerText = p.neighborhood || '';
      $('#detail-sak').innerText = p.sak ? 'Ù†Ø¹Ù…' : 'Ù„Ø§';
      $('#detail-bank').innerText = p.bankAccepted ? 'Ù†Ø¹Ù…' : 'Ù„Ø§';
      $('#detail-owner').innerText = p.ownerRole === 'broker' ? 'ÙˆØ³ÙŠØ·' : 'Ù…Ø¯ÙŠØ±';

      const gallery = $('#detail-images'); gallery.innerHTML = '';
      (p.images || []).forEach(u=>{
        const i = document.createElement('img'); i.src = u; gallery.appendChild(i);
      });

      $('#detail-view').style.display = 'block';
      window.scrollTo({top:0,behavior:'smooth'});
      // attach contact for detail view
      $('#contact-ws-detail').onclick = ()=> contactFromCard(id);
      $('#back-to-results').onclick = ()=> { $('#detail-view').style.display = 'none'; loadCards(); };
    }

    async function contactFromCard(propId){
      const doc = await db.collection('props').doc(propId).get(); if(!doc.exists) return alert('Ø§Ù„Ø¹Ø±Ø¶ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
      const p = {id:doc.id, ...doc.data()};
      // decide target number:
      let target = managerWhats;
      if(p.ownerRole === 'broker' && p.ownerId){
        const bdoc = await db.collection('users').doc(p.ownerId).get();
        if(bdoc.exists && bdoc.data().whatsapp) target = bdoc.data().whatsapp;
      }
      // message as required
      const msg = `Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ Ø£Ø±ØºØ¨ Ø¨Ø§Ù„Ø§Ø³ØªÙØ³Ø§Ø± Ø¹Ù† Ø§Ù„Ø¹Ù‚Ø§Ø± Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶ Ù„Ø¯ÙŠÙƒÙ… ÙÙŠ Ù…ÙˆÙ‚Ø¹ (Ø§Ù„Ù†Ø®Ø¨Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±ÙŠØ©):%0AØ§Ù„Ø¹Ø±Ø¶: ${encodeURIComponent(p.title)}%0AØ§Ù„Ø³Ø¹Ø±: ${encodeURIComponent(p.price)} Ø±ÙŠØ§Ù„%0AØ§Ù„Ù…Ø³Ø§Ø­Ø©: ${encodeURIComponent(p.area)} Ù…Â²%0AØ§Ù„Ø±Ø§Ø¨Ø·: ${encodeURIComponent(location.href)}%0AÙ‡Ù„ Ø§Ù„Ø¹Ù‚Ø§Ø± Ù„Ø§Ø²Ø§Ù„ Ù…ØªØ§Ø­Ø§Ù‹ØŸ`;
      const wa = `https://wa.me/${normPhone(target)}?text=${msg}`;
      window.open(wa,'_blank');
    }

    // not-found button (go to manager)
    $('#not-found').addEventListener('click', ()=>{
      const msg = 'Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ Ø¨Ø­Ø«Øª ÙÙŠ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù†Ø®Ø¨Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±ÙŠØ© ÙˆÙ„Ù… Ø£Ø¬Ø¯ Ø§Ù„Ø¹Ù‚Ø§Ø± Ø§Ù„Ø°ÙŠ Ø£Ø¨Ø­Ø« Ø¹Ù†Ù‡.';
      window.open(`https://wa.me/${normPhone(managerWhats)}?text=${encodeURIComponent(msg)}`,'_blank');
    });
    // floating whatsapp -> manager
    $('#wh-float').addEventListener('click', ()=>{
      const msg = 'Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ Ø£Ø±ÙŠØ¯ Ù…Ø³Ø§Ø¹Ø¯Ø© ÙÙŠ Ø¥ÙŠØ¬Ø§Ø¯ Ø¹Ù‚Ø§Ø± Ø¹Ù„Ù‰ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù†Ø®Ø¨Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±ÙŠØ©.';
      window.open(`https://wa.me/${normPhone(managerWhats)}?text=${encodeURIComponent(msg)}`,'_blank');
    });

    /*************** Simple auth (users collection) ***************/
    // login UI (modal-less simple)
    $('#btn-login-open').addEventListener('click', openLogin);
    $('#open-login-2') && $('#open-login-2').addEventListener('click', openLogin);
    function openLogin(){
      const username = prompt('Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:','IVL511');
      if(!username) return;
      const password = prompt('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±:','IVL511');
      if(!password) return;
      login(username.trim(), password.trim());
    }

    async function login(username, password){
      const q = await db.collection('users').where('username','==',username).where('password','==',password).where('active','==',true).get();
      if(q.empty){ alert('Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ­ÙŠØ­Ø© Ø£Ùˆ Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…ÙˆÙ‚ÙˆÙ'); return; }
      const doc = q.docs[0];
      currentUser = {id:doc.id, ...doc.data()};
      if(currentUser.role === 'admin') openAdminDashboard();
      else openBrokerDashboard();
    }

    /*************** Admin dashboard (simple prompts for actions) ***************/
    function openAdminDashboard(){
      // small management via prompts (quick admin tools)
      const choice = prompt('Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¯ÙŠØ±: Ø§ÙƒØªØ¨ Ø±Ù‚Ù… Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡:\\n1- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª\\n2- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙˆØ³Ø·Ø§Ø¡\\n3- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹\\n(Ø£ØºÙ„Ù‚ Ù„Ø¥Ù„ØºØ§Ø¡)','1');
      if(!choice) return;
      if(choice === '1'){ adminManageProps(); }
      else if(choice === '2'){ adminManageBrokers(); }
      else if(choice === '3'){ adminSettings(); }
    }

    async function adminManageProps(){
      const all = await db.collection('props').orderBy('createdAt','desc').get();
      let list = 'Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª:\\n';
      all.forEach((d,i)=>{ const p = d.data(); list += `${i+1}. ${p.title} â€” ${p.region} â€” ${fmt(p.price)} Ø±.Ø³ (id:${d.id})\\n`; });
      const action = prompt(list + '\\nØ®ÙŠØ§Ø±Ø§Øª: \\n- Ø§Ø¯Ø®Ù„ ID Ù„Ù†Ù‚Ù„ Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„ (Ø§Ù†Ø³Ø® id)\\n- Ø§ÙƒØªØ¨ DELETE:{id} Ù„Ù„Ø­Ø°Ù\\n- Ø§ÙƒØªØ¨ EDIT:{id} Ù„Ù„ØªØ¹Ø¯ÙŠÙ„','');
      if(!action) return;
      if(action.startsWith('DELETE:')){ const id = action.split(':')[1].trim(); if(confirm('ØªØ£ÙƒÙŠØ¯ Ø­Ø°ÙØŸ')){ await db.collection('props').doc(id).delete(); alert('ØªÙ… Ø§Ù„Ø­Ø°Ù'); } return; }
      if(action.startsWith('EDIT:')){ const id = action.split(':')[1].trim(); editPropPrompt(id); return; }
      // else open detail if matches id
      if(action.trim()){ showDetail(action.trim()); }
    }

    async function editPropPrompt(id){
      const doc = await db.collection('props').doc(id).get(); if(!doc.exists) return alert('ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
      const p = doc.data();
      const title = prompt('Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¹Ø±Ø¶:', p.title) || p.title;
      const price = prompt('Ø§Ù„Ø³Ø¹Ø± (Ø£Ø±Ù‚Ø§Ù…):', p.price) || p.price;
      const area = prompt('Ø§Ù„Ù…Ø³Ø§Ø­Ø© (Ù…Â²):', p.area) || p.area;
      const desc = prompt('Ø§Ù„ÙˆØµÙ:', p.desc) || p.desc;
      await db.collection('props').doc(id).update({title, price, area, desc});
      alert('ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«');
      loadCards();
    }

    async function adminManageBrokers(){
      const q = await db.collection('users').where('role','==','broker').get();
      let list = 'Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙˆØ³Ø·Ø§Ø¡:\\n';
      q.forEach((d,i)=>{ const b = d.data(); list += `${i+1}. ${b.username} â€” ÙˆØ§ØªØ³Ø§Ø¨:${b.whatsapp||'-'} â€” active:${b.active} (id:${d.id})\\n`; });
      const action = prompt(list + '\\nØ®ÙŠØ§Ø±Ø§Øª: CREATE | TOGGLE:{id} | EDIT:{id}','');
      if(!action) return;
      if(action === 'CREATE'){
        const u = prompt('Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù„ÙˆØ³ÙŠØ·:'); if(!u) return;
        const p = prompt('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±:') || 'password';
        const w = prompt('Ø±Ù‚Ù… ÙˆØ§ØªØ³Ø§Ø¨:') || '';
        await db.collection('users').add({username:u,password:p,role:'broker',active:true,whatsapp:w,createdAt: firebase.firestore.FieldValue.serverTimestamp()});
        alert('ØªÙ… Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡'); return;
      }
      if(action.startsWith('TOGGLE:')){ const id = action.split(':')[1].trim(); const ref = db.collection('users').doc(id); const s = await ref.get(); if(!s.exists) return alert('ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯'); await ref.update({active: !s.data().active}); alert('ØªÙ… Ø§Ù„ØªØ¨Ø¯ÙŠÙ„'); return; }
      if(action.startsWith('EDIT:')){ const id = action.split(':')[1].trim(); const snap = await db.collection('users').doc(id).get(); if(!snap.exists) return alert('ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯'); const b = snap.data(); const u = prompt('Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:', b.username) || b.username; const p = prompt('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±:', b.password) || b.password; const w = prompt('Ø±Ù‚Ù… ÙˆØ§ØªØ³Ø§Ø¨:', b.whatsapp) || b.whatsapp; await db.collection('users').doc(id).update({username:u,password:p,whatsapp:w}); alert('ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«'); return; }
    }

    async function adminSettings(){
      const setRef = db.collection('settings').doc('site'); const s = await setRef.get(); const data = s.exists? s.data(): {};
      const newNumber = prompt('Ø±Ù‚Ù… ÙˆØ§ØªØ³Ø§Ø¨ Ø§Ù„Ù…Ø¯ÙŠØ±:', data.managerWhats || managerWhats);
      if(newNumber !== null){ await setRef.set({managerWhats: newNumber},{merge:true}); managerWhats = newNumber; $('#manager-number').innerText = managerWhats; alert('ØªÙ… Ø§Ù„Ø­ÙØ¸'); }
    }

    /*************** Broker dashboard (simple) ***************/
    async function openBrokerDashboard(){
      // minimal broker UI via prompts
      const choice = prompt('Ù„ÙˆØ­Ø© Ø§Ù„ÙˆØ³ÙŠØ·: Ø§ÙƒØªØ¨ Ø±Ù‚Ù… Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡:\\n1- Ø¹Ø±Ø¶ Ø¹Ù‚Ø§Ø±Ø§ØªÙŠ\\n2- Ø¥Ø¶Ø§ÙØ© Ø¹Ù‚Ø§Ø±\\n3- ØªØ¹Ø¯ÙŠÙ„ Ø±Ù‚Ù… Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨','1');
      if(!choice) return;
      if(choice === '1') await brokerListProps();
      else if(choice === '2') await brokerAddProp();
      else if(choice === '3') await brokerUpdateWhats();
    }

    async function brokerListProps(){
      const snap = await db.collection('props').where('ownerId','==',currentUser.id).orderBy('createdAt','desc').get();
      let list = 'Ø¹Ù‚Ø§Ø±Ø§ØªÙŠ:\\n';
      snap.forEach((d,i)=>{ const p = d.data(); list += `${i+1}. ${p.title} â€” ${fmt(p.price)} â€” id:${d.id}\\n`; });
      const action = prompt(list + '\\nØ§ÙƒØªØ¨ DELETE:{id} Ø£Ùˆ EDIT:{id} Ø£Ùˆ Ø§ØºÙ„Ù‚ Ù„Ø¥Ù„ØºØ§Ø¡','');
      if(!action) return;
      if(action.startsWith('DELETE:')){ const id = action.split(':')[1].trim(); if(confirm('ØªØ£ÙƒÙŠØ¯ Ø­Ø°ÙØŸ')){ await db.collection('props').doc(id).delete(); alert('ØªÙ… Ø§Ù„Ø­Ø°Ù'); } return; }
      if(action.startsWith('EDIT:')){ const id = action.split(':')[1].trim(); await editPropPrompt(id); return; }
    }

    async function brokerAddProp(){
      const type = prompt('Ø§Ù„ØªØµÙ†ÙŠÙ (ÙÙŠÙ„Ø§/Ø´Ù‚Ø©/Ø¹Ù…Ø§Ø±Ø©/Ø£Ø±Ø¶/Ø§Ø³ØªØ±Ø§Ø­Ø©):','ÙÙŠÙ„Ø§') || 'ÙÙŠÙ„Ø§';
      const title = prompt('Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¹Ø±Ø¶:','ÙÙŠÙ„Ø§ ÙØ§Ø®Ø±Ø©') || 'Ø¹Ø±Ø¶';
      const price = prompt('Ø§Ù„Ø³Ø¹Ø± (Ø£Ø±Ù‚Ø§Ù…):','1000000') || '0';
      const area = prompt('Ø§Ù„Ù…Ø³Ø§Ø­Ø© (Ù…Â²):','300') || '';
      const region = prompt('Ø§Ù„Ù…ÙˆÙ‚Ø¹ (Ø´Ù…Ø§Ù„ Ø§Ù„Ø·Ø§Ø¦Ù/Ø¬Ù†ÙˆØ¨ Ø§Ù„Ø·Ø§Ø¦Ù/Ø´Ø±Ù‚ Ø§Ù„Ø·Ø§Ø¦Ù/ØºØ±Ø¨ Ø§Ù„Ø·Ø§Ø¦Ù):','Ø´Ù…Ø§Ù„ Ø§Ù„Ø·Ø§Ø¦Ù') || '';
      const neighborhood = prompt('Ø§Ù„Ø­ÙŠ/Ø§Ù„Ù…Ù†Ø·Ù‚Ø©:','') || '';
      const sak = confirm('Ù‡Ù„ ÙŠÙˆØ¬Ø¯ ØµÙƒØŸ OK = Ù†Ø¹Ù…') ? true : false;
      let bankAccepted = false;
      if(sak) bankAccepted = confirm('ÙŠÙ‚Ø¨Ù„ Ø§Ù„Ø¨Ù†ÙƒØŸ OK = Ù†Ø¹Ù…') ? true : false;
      const desc = prompt('Ø§Ù„ÙˆØµÙ:','ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ù‚Ø§Ø±...') || '';
      // images: for quick demo we skip uploads via prompts. Use UI to upload later.
      await db.collection('props').add({
        type, title, price, area, region, neighborhood, sak, bankAccepted, desc,
        images: [], ownerRole: 'broker', ownerId: currentUser.id, createdAt: firebase.firestore.FieldValue.serverTimestamp(), views:0
      });
      alert('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù‚Ø§Ø± (ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØµÙˆØ± Ù„Ø§Ø­Ù‚Ø§Ù‹ Ù…Ù† Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¯ÙŠØ±)');
      loadCards();
    }

    async function brokerUpdateWhats(){
      const w = prompt('Ø§Ø¯Ø®Ù„ Ø±Ù‚Ù… ÙˆØ§ØªØ³Ø§Ø¨ (10-12 Ø±Ù‚Ù…):', currentUser.whatsapp || '') || '';
      await db.collection('users').doc(currentUser.id).update({whatsapp:w});
      currentUser.whatsapp = w;
      alert('ØªÙ… Ø§Ù„Ø­ÙØ¸');
    }

    /*************** small UX: buttons linking ***************/
    $('#btn-home').addEventListener('click', ()=>{ $('#detail-view').style.display='none'; loadCards(); });

    // quick open-login id (maybe present)
    const openLogin2 = $('#open-login-2');
    if(openLogin2) openLogin2.addEventListener('click', openLogin);

    // allow pressing Enter in search field to search
    $('#q').addEventListener('keydown', (e)=>{ if(e.key === 'Enter') $('#btn-search').click(); });

  </script>
</body>
</html>
