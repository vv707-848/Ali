<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Ø§Ù„Ù†Ø®Ø¨Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±ÙŠØ© â€” Ù…Ù†ØµØ© Ø§Ø­ØªØ±Ø§ÙÙŠØ©</title>
  <meta name="description" content="Ø§Ù„Ù†Ø®Ø¨Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±ÙŠØ© â€” Ù…Ù†ØµØ© Ø¹Ù‚Ø§Ø±ÙŠØ© Ø§Ø­ØªØ±Ø§ÙÙŠØ© Ù„Ù„Ø¨ÙŠØ¹. ØªÙˆØ§ØµÙ„ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨ Ù…Ø¨Ø§Ø´Ø±Ø© Ù…Ø¹ Ø§Ù„ÙˆØ³ÙŠØ· Ø£Ùˆ Ø§Ù„Ù…Ø¯ÙŠØ±.">
  <style>
    /* ---------------- Design (modern, RTL, professional) ---------------- */
    :root{
      --bg: #0f172a10;
      --card: #ffffff;
      --muted: #6b7280;
      --accent: #0b6cf5;
      --accent-2: #0b87ff;
      --glass: rgba(255,255,255,0.75);
      --danger: #ef4444;
      --success: #16a34a;
      --radius: 14px;
      font-family: Inter, "Noto Sans Arabic", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#f3f7ff 0%, #f7fbff 50%);color:#0b1220}
    a{color:inherit;text-decoration:none}
    /* header */
    header{position:sticky;top:0;z-index:90;background:rgba(255,255,255,0.9);backdrop-filter:blur(6px);border-bottom:1px solid #eef4ff;padding:12px 24px;display:flex;align-items:center;gap:16px}
    .container{max-width:1200px;margin:18px auto;padding:0 18px}
    .logo{display:flex;align-items:center;gap:12px}
    .logo img{width:56px;height:56px;border-radius:12px;object-fit:cover;box-shadow:0 6px 20px rgba(11,108,245,0.06)}
    .brand-title{font-weight:800;font-size:18px}
    .brand-sub{color:var(--muted);font-size:13px}
    .top-actions{margin-left:auto;display:flex;gap:10px;align-items:center}

    /* button */
    .btn{display:inline-flex;gap:8px;align-items:center;padding:10px 14px;border-radius:12px;border:0;cursor:pointer;background:var(--accent);color:white;font-weight:700;box-shadow:0 8px 30px rgba(11,108,245,0.08)}
    .btn.ghost{background:transparent;color:var(--accent);border:1px solid rgba(11,108,245,0.12);box-shadow:none}
    .btn.small{padding:8px 10px;border-radius:10px;font-weight:700}

    /* hero & search */
    .hero{display:flex;gap:18px;align-items:stretch;margin-top:18px}
    .search-panel{flex:1;background:linear-gradient(180deg,#fff,#f8fbff);padding:18px;border-radius:16px;box-shadow:0 12px 40px rgba(2,6,23,0.06)}
    .search-row{display:flex;gap:10px;align-items:center}
    input,select,textarea{padding:12px;border-radius:10px;border:1px solid #eef3ff;font-size:15px}
    input::placeholder{color:#9aa4c4}
    .cats{display:flex;gap:12px;margin-top:12px;flex-wrap:wrap}

    /* layout */
    .grid{display:grid;grid-template-columns:1fr 360px;gap:20px;margin-top:20px}
    .cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:18px}
    .card{background:var(--card);border-radius:12px;overflow:hidden;display:flex;flex-direction:column;transition:transform .18s,box-shadow .18s;box-shadow:0 10px 30px rgba(2,6,23,0.06)}
    .card:hover{transform:translateY(-8px);box-shadow:0 20px 60px rgba(2,6,23,0.09)}
    .thumb{height:180px;background:linear-gradient(90deg,#eef6ff,#f8fbff);display:flex;align-items:center;justify-content:center}
    .thumb img{width:100%;height:100%;object-fit:cover}
    .card-body{padding:12px;display:flex;flex-direction:column;gap:8px}
    .price{color:var(--accent);font-weight:900;font-size:16px}
    .meta{color:var(--muted);font-size:13px}
    .card-actions{display:flex;gap:8px;padding:12px;border-top:1px solid #f3f6fb}

    /* aside */
    .panel{background:linear-gradient(180deg,#fff,#fcfeff);padding:12px;border-radius:12px;box-shadow:0 12px 36px rgba(2,6,23,0.06)}
    .stat-row{display:flex;gap:12px;align-items:center;justify-content:space-between}

    /* modal (forms) */
    .modal-back{position:fixed;inset:0;background:rgba(2,6,23,0.5);display:none;align-items:center;justify-content:center;z-index:120}
    .modal{width:940px;max-width:95%;background:var(--card);border-radius:14px;padding:18px;box-shadow:0 30px 80px rgba(2,6,23,0.2);max-height:90vh;overflow:auto}
    .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .full{grid-column:1/-1}

    /* dashboard */
    .dashboard{display:flex;gap:18px;align-items:flex-start}
    .sidebar{min-width:260px;background:var(--card);padding:12px;border-radius:12px;box-shadow:0 12px 36px rgba(2,6,23,0.06)}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{padding:8px;border-bottom:1px solid #f3f6fb;text-align:right;font-size:13px}

    /* uploader preview */
    .images-preview{display:flex;gap:8px;flex-wrap:wrap}
    .img-thumb{width:100px;height:70px;border-radius:8px;overflow:hidden;box-shadow:0 6px 20px rgba(2,6,23,0.06)}
    .img-thumb img{width:100%;height:100%;object-fit:cover}

    /* responsive */
    @media(max-width:980px){ .grid{grid-template-columns:1fr} .hero{flex-direction:column} .sidebar{display:none} }
  </style>
</head>
<body>
  <header>
    <div class="container" style="display:flex;align-items:center;">
      <div class="logo">
        <img id="logo-preview" src="" alt="logo">
        <div>
          <div class="brand-title">Ø§Ù„Ù†Ø®Ø¨Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±ÙŠØ©</div>
          <div class="brand-sub">Ù…Ù†ØµØ© Ø§Ø­ØªØ±Ø§ÙÙŠØ© Ù„Ù„Ø¨ÙŠØ¹ â€” ØªÙˆØ§ØµÙ„ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨</div>
        </div>
      </div>
      <div class="top-actions">
        <button class="btn ghost" id="btn-home">Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
        <button class="btn" id="btn-open-login">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</button>
      </div>
    </div>
  </header>

  <main class="container">
    <!-- HERO / SEARCH -->
    <section class="hero">
      <div class="search-panel">
        <h2 style="margin:0 0 6px 0">Ø§Ø¨Ø­Ø« Ø¹Ù† Ø¹Ù‚Ø§Ø±Ùƒ Ø§Ù„ØªØ§Ù„ÙŠ</h2>
        <p style="margin:0 0 12px;color:var(--muted)">ÙÙ„ØªØ± Ø´Ø§Ù…Ù„ ÙˆØ³Ù‡Ù„ â€” Ø§Ø®ØªØ± Ø§Ù„Ù†ÙˆØ¹ØŒ Ø§Ù„Ù…Ù†Ø·Ù‚Ø©ØŒ Ø£Ùˆ Ø§ÙƒØªØ¨ Ù…Ø§ ØªØ±ÙŠØ¯.</p>

        <div class="search-row">
          <input id="q" placeholder="Ù…Ø«Ø§Ù„: ÙÙŠÙ„Ø§ ÙØ§Ø®Ø±Ø©ØŒ Ø§Ù„Ø­ÙˆÙŠØ©ØŒ 1500000"/>
          <select id="filter-type"><option value="">ÙƒÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</option><option>ÙÙŠÙ„Ø§</option><option>Ø´Ù‚Ø©</option><option>Ø¹Ù…Ø§Ø±Ø©</option><option>Ø£Ø±Ø¶</option><option>Ø§Ø³ØªØ±Ø§Ø­Ø©</option></select>
          <select id="filter-region"><option value="">ÙƒÙ„ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚</option><option>Ø´Ù…Ø§Ù„ Ø§Ù„Ø·Ø§Ø¦Ù</option><option>Ø¬Ù†ÙˆØ¨ Ø§Ù„Ø·Ø§Ø¦Ù</option><option>Ø´Ø±Ù‚ Ø§Ù„Ø·Ø§Ø¦Ù</option><option>ØºØ±Ø¨ Ø§Ù„Ø·Ø§Ø¦Ù</option></select>
          <button class="btn" id="btn-search">Ø§Ø¨Ø­Ø«</button>
        </div>

        <div class="cats" style="margin-top:12px">
          <div class="cat" data-type="ÙÙŠÙ„Ø§">ğŸ¡ ÙÙŠÙ„Ø§</div>
          <div class="cat" data-type="Ø´Ù‚Ø©">ğŸ˜ Ø´Ù‚Ø©</div>
          <div class="cat" data-type="Ø¹Ù…Ø§Ø±Ø©">ğŸ¢ Ø¹Ù…Ø§Ø±Ø©</div>
          <div class="cat" data-type="Ø£Ø±Ø¶">ğŸŸ© Ø£Ø±Ø¶</div>
          <div class="cat" data-type="Ø§Ø³ØªØ±Ø§Ø­Ø©">ğŸŒ´ Ø§Ø³ØªØ±Ø§Ø­Ø©</div>
        </div>
      </div>

      <aside style="width:360px">
        <div class="panel">
          <h3 style="margin-top:0">Ù„Ù… Ø£Ø¬Ø¯ Ø§Ù„Ø¹Ù‚Ø§Ø± Ø§Ù„Ù…Ù†Ø§Ø³Ø¨</h3>
          <p style="color:var(--muted)">Ø§Ø¶ØºØ· ÙˆØ³Ù†ØªÙˆØ§ØµÙ„ Ù…Ø¹Ùƒ Ø´Ø®ØµÙŠØ§Ù‹.</p>
          <button class="btn" id="not-found">Ù„Ù… Ø£Ø¬Ø¯ Ø§Ù„Ø¹Ù‚Ø§Ø± Ø§Ù„Ù…Ù†Ø§Ø³Ø¨</button>
          <hr style="margin:12px 0;border:none;border-top:1px dashed #eef4ff">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <div class="meta">Ø§ØªØµÙ„ Ø¨Ø§Ù„Ù…Ø¯ÙŠØ±</div>
              <div style="font-weight:800;margin-top:6px" id="manager-number">0535342404</div>
            </div>
            <div style="text-align:left">
              <small class="meta">ÙŠÙˆØ²Ø± ØªØ¬Ø±ÙŠØ¨ÙŠ</small>
              <div style="font-weight:800">IVL511</div>
            </div>
          </div>
        </div>
      </aside>
    </section>

    <!-- main grid -->
    <section class="grid">
      <section>
        <div id="cards" class="cards" aria-live="polite"></div>
      </section>

      <aside class="sidebar">
        <div style="display:flex;flex-direction:column;gap:12px">
          <div>
            <h4 style="margin:0 0 6px 0">Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</h4>
            <div class="stat-row">
              <div><div style="font-weight:800" id="stat-props">0</div><div class="meta">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª</div></div>
              <div><div style="font-weight:800" id="stat-brokers">0</div><div class="meta">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙˆØ³Ø·Ø§Ø¡</div></div>
            </div>
          </div>

          <div>
            <h4 style="margin:0 0 6px 0">Ø¥Ø¯Ø§Ø±Ø© Ø³Ø±ÙŠØ¹Ø©</h4>
            <button class="btn small" id="open-admin">Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¯ÙŠØ±</button>
            <button class="btn small ghost" id="open-broker">Ù„ÙˆØ­Ø© Ø§Ù„ÙˆØ³ÙŠØ·</button>
          </div>

          <div>
            <h4 style="margin:0 0 6px 0">Ø£Ù‚Ø³Ø§Ù… Ø³Ø±ÙŠØ¹Ø©</h4>
            <div style="display:flex;flex-direction:column;gap:8px">
              <div class="cat" data-type="ÙÙŠÙ„Ø§">ğŸ¡ ÙÙŠÙ„Ø§</div>
              <div class="cat" data-type="Ø´Ù‚Ø©">ğŸ˜ Ø´Ù‚Ø©</div>
              <div class="cat" data-type="Ø£Ø±Ø¶">ğŸŸ© Ø£Ø±Ø¶</div>
            </div>
          </div>
        </div>
      </aside>
    </section>
  </main>

  <!-- MODAL: Login / Admin / Broker / Forms -->
  <div class="modal-back" id="modal-back">
    <div class="modal" id="modal">
      <!-- content injected by JS -->
    </div>
  </div>

  <footer style="text-align:center;color:var(--muted);margin:28px 0">Â© Ø§Ù„Ù†Ø®Ø¨Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±ÙŠØ©</footer>

  <!-- Firebase SDK (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>

  <script>
  /**************************************************************************
   * Ø§Ù„Ù†Ø®Ø¨Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±ÙŠØ© â€” Single-file app
   * - ÙˆØ§Ø¬Ù‡Ø© Ø¹Ø§Ù…Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª
   * - Ù„ÙˆØ­Ø© Ù…Ø¯ÙŠØ± ÙˆØ§Ø¬Ù‡Ø© Ø±Ø³ÙˆÙ…ÙŠØ© ÙƒØ§Ù…Ù„Ø© (Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„/Ø­Ø°Ù ÙˆØ³Ø·Ø§Ø¡ ÙˆØ¹Ù‚Ø§Ø±Ø§Øª)
   * - Ù„ÙˆØ­Ø© ÙˆØ³ÙŠØ· Ù„Ø¥Ø¯Ø§Ø±Ø© Ø¹Ù‚Ø§Ø±Ø§ØªÙ‡ ÙˆÙ…Ù„ÙÙ‡ Ø§Ù„Ø´Ø®ØµÙŠ
   * - Ø±ÙØ¹ ØµÙˆØ± Ø¥Ù„Ù‰ Firebase StorageØŒ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­ÙÙˆØ¸Ø© ÙÙŠ Firestore
   * - Ù…Ù†Ø·Ù‚ ÙˆØ§ØªØ³Ø§Ø¨: Ø¹Ù‚Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø¯ÙŠØ± -> Ù…Ø¯ÙŠØ± (0535342404)ØŒ Ø¹Ù‚Ø§Ø±Ø§Øª Ø§Ù„ÙˆØ³ÙŠØ· -> Ø±Ù‚Ù… Ø§Ù„ÙˆØ³ÙŠØ· Ø§Ù„Ù…Ø³Ø¬Ù„
   *
   * Ù…Ù„Ø§Ø­Ø¸Ø© Ø£Ù…Ø§Ù†: Ù‡Ø°Ø§ Ù…Ø«Ø§Ù„ Ø¬Ø§Ù‡Ø² Ù„Ù„ØªØ´ØºÙŠÙ„. Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ù†ØªØ§Ø¬:
   * - Ù†ÙÙ‘Ø° Firebase Auth + Ù‚ÙˆØ§Ø¹Ø¯ Firestore/Storage Ù…Ù†Ø§Ø³Ø¨Ø©
   * - Ù„Ø§ ØªØ®Ø²Ù† ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ± Ù†ØµØ§Ù‹ Ø¹Ø§Ø¯ÙŠÙ‹Ø§ ÙÙŠ Ø§Ù„Ø¥Ù†ØªØ§Ø¬ (Ù‡Ù†Ø§ Ù„Ù„Ø³Ù‡ÙˆÙ„Ø© ÙˆØ§Ù„ØªØ¬Ø±Ø¨Ø©)
   **************************************************************************/

  // ---------- Firebase config (provided) ----------
  const firebaseConfig = {
    apiKey: "AIzaSyApEkbNuWz1nd0DSwt4lirlVlUSt3GNB0Y",
    authDomain: "alnokhbu.firebaseapp.com",
    projectId: "alnokhbu",
    storageBucket: "alnokhbu.firebasestorage.app",
    messagingSenderId: "647865484582",
    appId: "1:647865484582:web:162d57ee1dfab160c9ede7",
    measurementId: "G-GMZB6BG3LY"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const storage = firebase.storage();

  // ---------- App state ----------
  let managerWhats = '0535342404';
  let currentUser = null; // {id, username, role: 'admin'|'broker', whatsapp, active}
  let modalBack = document.getElementById('modal-back');
  let modal = document.getElementById('modal');

  // ---------- utils ----------
  const $ = (s) => document.querySelector(s);
  const $$ = (s) => Array.from(document.querySelectorAll(s));
  const esc = s => (s||'').toString().replace(/[&<>\"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  const fmt = n => (n||'').toString().replace(/(\\d)(?=(\\d{3})+$)/g,'$1,');
  const normPhone = n => (n||'').toString().replace(/[^0-9]/g,'');

  // ---------- UI wiring ----------
  document.getElementById('btn-open-login').addEventListener('click', openLoginModal);
  document.getElementById('btn-home').addEventListener('click', ()=>{ hideModal(); loadCards(); $('#detail-view') && ($('#detail-view').style.display='none'); });
  document.getElementById('open-admin').addEventListener('click', openLoginModal);
  document.getElementById('open-broker').addEventListener('click', openLoginModal);
  document.getElementById('btn-search').addEventListener('click', ()=> loadCards({q:$('#q').value, type:$('#filter-type').value, region:$('#filter-region').value}));
  $$('.cat').forEach(c=>c.addEventListener('click', e => { $('#filter-type').value = e.currentTarget.dataset.type; loadCards({type: e.currentTarget.dataset.type}); }));
  document.getElementById('not-found').addEventListener('click', ()=> {
    const msg = 'Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ Ø¨Ø­Ø«Øª ÙÙŠ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù†Ø®Ø¨Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±ÙŠØ© ÙˆÙ„Ù… Ø£Ø¬Ø¯ Ø§Ù„Ø¹Ù‚Ø§Ø± Ø§Ù„Ø°ÙŠ Ø£Ø¨Ø­Ø« Ø¹Ù†Ù‡.';
    window.open(`https://wa.me/${normPhone(managerWhats)}?text=${encodeURIComponent(msg)}`, '_blank');
  });

  // ---------- modal helpers ----------
  function showModal(contentHtml){
    modal.innerHTML = contentHtml;
    modalBack.style.display = 'flex';
  }
  function hideModal(){ modalBack.style.display = 'none'; modal.innerHTML = ''; }

  modalBack.addEventListener('click', (e) => { if(e.target === modalBack) hideModal(); });

  // ---------- Defaults on first run ----------
  async function ensureDefaults(){
    // settings
    const setRef = db.collection('settings').doc('site');
    const setSnap = await setRef.get();
    if(!setSnap.exists){
      await setRef.set({managerWhats:'0535342404', logo:'', createdAt: firebase.firestore.FieldValue.serverTimestamp()});
      managerWhats = '0535342404';
    } else {
      const data = setSnap.data();
      managerWhats = data.managerWhats || managerWhats;
      if(data.logo) $('#logo-preview').src = data.logo;
    }
    $('#manager-number').innerText = managerWhats;

    // default admin user
    const q = await db.collection('users').where('username','==','IVL511').get();
    if(q.empty){
      await db.collection('users').add({username:'IVL511', password:'IVL511', role:'admin', active:true, whatsapp: managerWhats, createdAt: firebase.firestore.FieldValue.serverTimestamp()});
    }

    // if no props, add sample
    const propsSnap = await db.collection('props').limit(1).get();
    if(propsSnap.empty){
      await db.collection('props').add({
        type:'ÙÙŠÙ„Ø§', title:'ÙÙŠÙ„Ø§ ÙØ§Ø®Ø±Ø© Ù„Ù„Ø¨ÙŠØ¹', price:'1500000', area:'500',
        region:'Ø´Ù…Ø§Ù„ Ø§Ù„Ø·Ø§Ø¦Ù', neighborhood:'Ø§Ù„Ø­ÙˆÙŠØ©', sak:true, bankAccepted:true, desc:'ÙÙŠÙ„Ø§ ÙØ§Ø®Ø±Ø© Ø¨Ù…ÙˆØ§ØµÙØ§Øª Ø¹Ø§Ù„ÙŠØ© ÙÙŠ Ù…ÙˆÙ‚Ø¹ Ù…Ù…ÙŠØ².',
        images:[], ownerRole:'admin', ownerId:null, createdAt: firebase.firestore.FieldValue.serverTimestamp(), views:0
      });
    }
  }

  // ---------- Render public cards ----------
  async function loadCards(filter = {}){
    const snap = await db.collection('props').orderBy('createdAt','desc').get();
    const all = []; snap.forEach(d=> all.push({id:d.id, ...d.data()}));
    const qtext = (filter.q||'').toString().toLowerCase();
    const filtered = all.filter(p=>{
      if(filter.type && filter.type !== p.type) return false;
      if(filter.region && filter.region !== p.region) return false;
      if(qtext && !((p.title||'').toLowerCase().includes(qtext) || (p.neighborhood||'').toLowerCase().includes(qtext) || (p.desc||'').toLowerCase().includes(qtext))) return false;
      return true;
    });

    $('#cards').innerHTML = '';
    if(!filtered.length){ $('#cards').innerHTML = '<div style="padding:18px;background:#fff;border-radius:12px">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ø±ÙˆØ¶ Ø­Ø§Ù„ÙŠØ§Ù‹</div>'; return; }

    filtered.forEach(p=>{
      const img = (p.images && p.images.length) ? p.images[0] : '';
      const div = document.createElement('div'); div.className = 'card';
      div.innerHTML = `
        <div class="thumb">${ img ? `<img src="${esc(img)}" alt="${esc(p.title)}">` : '<div style="padding:14px;color:var(--muted)">Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ±Ø©</div>' }</div>
        <div class="card-body">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <div class="price">${fmt(p.price)} Ø±.Ø³</div>
              <div style="font-weight:800">${esc(p.title)}</div>
            </div>
            <div style="text-align:left">
              <div class="meta">${esc(p.region)}</div>
              <div class="meta">${esc(p.area)} Ù…Â²</div>
            </div>
          </div>
          <div class="meta">${esc(p.neighborhood) || ''}</div>
        </div>
        <div class="card-actions">
          <button class="btn small detail-btn" data-id="${p.id}">Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„</button>
          <button class="btn small ghost contact-btn" data-id="${p.id}">ÙˆØ§ØªØ³Ø§Ø¨</button>
        </div>`;
      $('#cards').appendChild(div);
    });

    // events
    $$('.detail-btn').forEach(b => b.addEventListener('click', e => showDetail(e.currentTarget.dataset.id)));
    $$('.contact-btn').forEach(b => b.addEventListener('click', e => contactFromCard(e.currentTarget.dataset.id)));

    // stats:
    const statsP = await db.collection('props').get(); $('#stat-props').innerText = statsP.size;
    const statsB = await db.collection('users').where('role','==','broker').get(); $('#stat-brokers').innerText = statsB.size;
  }

  // ---------- Detail view ----------
  async function showDetail(id){
    const doc = await db.collection('props').doc(id).get();
    if(!doc.exists) return alert('Ø§Ù„Ø¹Ø±Ø¶ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
    const p = {id: doc.id, ...doc.data()};
    // increment views
    await db.collection('props').doc(id).update({views: (p.views||0)+1});
    // render in modal
    let imagesHtml = '';
    (p.images || []).forEach(u => imagesHtml += `<img src="${esc(u)}" style="height:160px;border-radius:10px;margin-right:8px">`);
    const content = `
      <h3 style="margin-top:0">${esc(p.title)}</h3>
      <div style="display:flex;gap:12px;align-items:center;justify-content:space-between">
        <div><div class="price">${fmt(p.price)} Ø±.Ø³</div><div class="meta">${esc(p.region)} â€” ${esc(p.neighborhood)}</div></div>
        <div style="text-align:left"><div class="meta">Ø§Ù„Ù…Ø³Ø§Ø­Ø©</div><div style="font-weight:800">${esc(p.area)} Ù…Â²</div></div>
      </div>
      <div style="margin-top:12px">${imagesHtml || '<div style="padding:14px;background:#f1f7ff;border-radius:10px">Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ±</div>'}</div>
      <p style="margin-top:12px;color:#263248">${esc(p.desc)}</p>
      <table style="width:100%;margin-top:8px"><tbody>
        <tr><th style="text-align:right;padding:8px">Ø§Ù„ØµÙƒ</th><td>${p.sak? 'Ù†Ø¹Ù…':'Ù„Ø§'}</td></tr>
        <tr><th style="text-align:right;padding:8px">ÙŠÙ‚Ø¨Ù„ Ø¨Ù†Ùƒ</th><td>${p.bankAccepted? 'Ù†Ø¹Ù…':'Ù„Ø§'}</td></tr>
        <tr><th style="text-align:right;padding:8px">Ù…Ø¹Ø±ÙˆØ¶ Ø¨ÙˆØ§Ø³Ø·Ø©</th><td>${p.ownerRole === 'broker' ? 'ÙˆØ³ÙŠØ·' : 'Ù…Ø¯ÙŠØ±'}</td></tr>
      </tbody></table>
      <div style="display:flex;gap:10px;margin-top:12px">
        <button class="btn" id="modal-contact">Ø§Ù„ØªÙˆØ§ØµÙ„ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨</button>
        <button class="btn ghost" id="modal-close">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>`;
    showModal(content);
    $('#modal-contact').addEventListener('click', ()=> {
      contactFromData(p);
    });
    $('#modal-close').addEventListener('click', hideModal);
  }

  // ---------- WhatsApp contact logic ----------
  async function contactFromCard(id){
    const doc = await db.collection('props').doc(id).get(); if(!doc.exists) return alert('Ø§Ù„Ø¹Ø±Ø¶ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
    const p = {id: doc.id, ...doc.data()};
    contactFromData(p);
  }
  async function contactFromData(p){
    let target = managerWhats;
    if(p.ownerRole === 'broker' && p.ownerId){
      const bdoc = await db.collection('users').doc(p.ownerId).get();
      if(bdoc.exists){ const b = bdoc.data(); if(b.whatsapp) target = b.whatsapp; }
    }
    const msg = `Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ Ø£Ø±ØºØ¨ Ø¨Ø§Ù„Ø§Ø³ØªÙØ³Ø§Ø± Ø¹Ù† Ø§Ù„Ø¹Ù‚Ø§Ø± Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶ Ù„Ø¯ÙŠÙƒÙ… ÙÙŠ Ù…ÙˆÙ‚Ø¹ (Ø§Ù„Ù†Ø®Ø¨Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±ÙŠØ©):%0AØ§Ù„Ø¹Ø±Ø¶: ${encodeURIComponent(p.title)}%0AØ§Ù„Ø³Ø¹Ø±: ${encodeURIComponent(p.price)} Ø±ÙŠØ§Ù„%0AØ§Ù„Ù…Ø³Ø§Ø­Ø©: ${encodeURIComponent(p.area)} Ù…Â²%0AØ§Ù„Ø±Ø§Ø¨Ø·: ${encodeURIComponent(location.href)}%0AÙ‡Ù„ Ø§Ù„Ø¹Ù‚Ø§Ø± Ù„Ø§Ø²Ø§Ù„ Ù…ØªØ§Ø­Ø§Ù‹ØŸ`;
    window.open(`https://wa.me/${normPhone(target)}?text=${msg}`, '_blank');
  }

  // ---------- Login Modal & Auth (simple using users collection) ----------
  function openLoginModal(){
    const html = `
      <h3 style="margin-top:0">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h3>
      <div style="display:flex;gap:12px">
        <div style="flex:1">
          <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
          <input id="login-username" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ù…Ø«Ø§Ù„ IVL511)"/>
          <label style="margin-top:8px">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
          <input id="login-password" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±"/>
          <div style="margin-top:12px;display:flex;gap:8px">
            <button class="btn" id="do-login">Ø¯Ø®ÙˆÙ„</button>
            <button class="btn ghost" id="cancel-login">Ø¥Ù„ØºØ§Ø¡</button>
          </div>
          <div id="login-msg" style="color:var(--danger);margin-top:8px"></div>
          <div style="margin-top:8px;color:var(--muted);font-size:13px">ÙŠÙˆØ²Ø± Ø§ÙØªØ±Ø§Ø¶ÙŠ: <b>IVL511</b> / ÙƒÙ„Ù…Ø©: <b>IVL511</b></div>
        </div>
        <div style="width:280px">
          <div style="background:#f6f9ff;padding:12px;border-radius:10px">
            <h4 style="margin:0 0 6px 0">Ù„Ù…Ø§Ø°Ø§ Ø§Ù„Ø¯Ø®ÙˆÙ„ØŸ</h4>
            <p style="margin:0;color:var(--muted)">Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¯ÙŠØ± ØªØªÙŠØ­ Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„/Ø­Ø°Ù Ø§Ù„ÙˆØ³Ø·Ø§Ø¡ ÙˆØ§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª. Ø§Ù„ÙˆØ³ÙŠØ· ÙŠØ¯ÙŠØ± Ø¹Ù‚Ø§Ø±Ø§ØªÙ‡ ÙÙ‚Ø·.</p>
          </div>
        </div>
      </div>`;
    showModal(html);
    $('#do-login').addEventListener('click', async ()=>{
      const u = $('#login-username').value.trim();
      const p = $('#login-password').value.trim();
      if(!u || !p){ $('#login-msg').innerText = 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„'; return; }
      const q = await db.collection('users').where('username','==',u).where('password','==',p).where('active','==',true).get();
      if(q.empty){ $('#login-msg').innerText = 'Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ­ÙŠØ­Ø© Ø£Ùˆ Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…ÙˆÙ‚ÙˆÙ'; return; }
      const doc = q.docs[0]; currentUser = {id: doc.id, ...doc.data()};
      hideModal();
      if(currentUser.role === 'admin') openAdminUI();
      else openBrokerUI();
    });
    $('#cancel-login').addEventListener('click', hideModal);
  }

  // ---------- Admin UI (full GUI inside modal) ----------
  async function openAdminUI(){
    // load data
    const propsSnap = await db.collection('props').orderBy('createdAt','desc').get();
    const props = []; propsSnap.forEach(d => props.push({id:d.id,...d.data()}));
    const brokersSnap = await db.collection('users').where('role','==','broker').get();
    const brokers = []; brokersSnap.forEach(d => brokers.push({id:d.id,...d.data()}));
    const content = `
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3 style="margin:0">Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¯ÙŠØ± â€” ${esc(currentUser.username)}</h3>
        <div><button class="btn ghost" id="admin-logout">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button></div>
      </div>
      <div style="margin-top:12px;display:grid;grid-template-columns:1fr 380px;gap:12px">
        <div>
          <div style="background:#fff;padding:12px;border-radius:12px"><h4 style="margin:0 0 8px 0">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª</h4>
            <table class="table" style="width:100%"><thead><tr><th>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th><th>Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</th><th>Ø§Ù„Ø³Ø¹Ø±</th><th>Ø§Ù„Ù…Ø§Ù„Ùƒ</th><th>Ø£ÙØ¹Ø§Ù„</th></tr></thead><tbody id="admin-props-rows">${props.map(p=>`<tr data-id="${p.id}"><td>${esc(p.title)}</td><td>${esc(p.region)} - ${esc(p.neighborhood)}</td><td>${fmt(p.price)}</td><td>${p.ownerRole}</td><td><button class="btn small admin-edit-prop" data-id="${p.id}">ØªØ¹Ø¯ÙŠÙ„</button> <button class="btn small ghost admin-del-prop" data-id="${p.id}">Ø­Ø°Ù</button></td></tr>`).join('')}</tbody></table>
            <div style="margin-top:8px"><button class="btn" id="admin-add-prop">Ø¥Ø¶Ø§ÙØ© Ø¹Ù‚Ø§Ø± Ø¬Ø¯ÙŠØ¯</button></div>
          </div>
        </div>

        <aside>
          <div style="background:#fff;padding:12px;border-radius:12px">
            <h4 style="margin:0 0 8px 0">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙˆØ³Ø·Ø§Ø¡</h4>
            <div style="margin-bottom:8px"><button class="btn" id="admin-new-broker">Ø¥Ø¶Ø§ÙØ© ÙˆØ³ÙŠØ·</button></div>
            <table class="table"><thead><tr><th>Ø§Ù„ÙˆØ³ÙŠØ·</th><th>ÙˆØ§ØªØ³Ø§Ø¨</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø£ÙØ¹Ø§Ù„</th></tr></thead><tbody id="admin-brokers-rows">${brokers.map(b=>`<tr data-id="${b.id}"><td>${esc(b.username)}</td><td>${esc(b.whatsapp||'-')}</td><td>${b.active? 'Ù…ÙØ¹Ù„':'Ù…ÙˆÙ‚ÙˆÙ'}</td><td><button class="btn small admin-toggle-broker" data-id="${b.id}">${b.active? 'Ø¥ÙŠÙ‚Ø§Ù':'ØªÙØ¹ÙŠÙ„'}</button> <button class="btn small ghost admin-edit-broker" data-id="${b.id}">ØªØ¹Ø¯ÙŠÙ„</button></td></tr>`).join('')}</tbody></table>
            <hr style="margin:12px 0;border:none;border-top:1px dashed #eef4ff">
            <h5 style="margin:0 0 8px 0">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹</h5>
            <div style="display:flex;flex-direction:column;gap:8px">
              <label>Ø±Ù‚Ù… ÙˆØ§ØªØ³Ø§Ø¨ Ø§Ù„Ù…Ø¯ÙŠØ±</label>
              <input id="admin-manager-whats" value="${esc(managerWhats)}"/>
              <label>Ø´Ø¹Ø§Ø± Ø§Ù„Ù…ÙˆÙ‚Ø¹</label>
              <input type="file" id="admin-logo-file"/>
              <div style="display:flex;gap:8px"><button class="btn" id="save-settings">Ø­ÙØ¸</button> <button class="btn ghost" id="close-admin">Ø¥ØºÙ„Ø§Ù‚</button></div>
            </div>
          </div>
        </aside>
      </div>
    `;
    showModal(content);

    // attach handlers
    document.getElementById('admin-logout').addEventListener('click', ()=>{ currentUser = null; hideModal(); alert('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬'); });
    document.getElementById('close-admin').addEventListener('click', hideModal);

    // add prop
    document.getElementById('admin-add-prop').addEventListener('click', ()=> openPropForm('create', null));

    // edit / delete props
    $$('.admin-edit-prop').forEach(btn => btn.addEventListener('click', e => openPropForm('edit', e.currentTarget.dataset.id)));
    $$('.admin-del-prop').forEach(btn => btn.addEventListener('click', async e => {
      const id = e.currentTarget.dataset.id;
      if(!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù‚Ø§Ø±ØŸ')) return;
      await db.collection('props').doc(id).delete();
      alert('ØªÙ… Ø§Ù„Ø­Ø°Ù');
      openAdminUI();
      loadCards();
    }));

    // brokers actions
    document.getElementById('admin-new-broker').addEventListener('click', ()=> openBrokerForm('create', null));
    $$('.admin-toggle-broker').forEach(btn => btn.addEventListener('click', async e => {
      const id = e.currentTarget.dataset.id;
      const ref = db.collection('users').doc(id);
      const snap = await ref.get(); if(!snap.exists) return;
      await ref.update({active: !snap.data().active});
      alert('ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«');
      openAdminUI();
    }));
    $$('.admin-edit-broker').forEach(btn => btn.addEventListener('click', e => openBrokerForm('edit', e.currentTarget.dataset.id)));

    // settings save
    document.getElementById('save-settings').addEventListener('click', async ()=>{
      const newNum = $('#admin-manager-whats').value.trim();
      const file = $('#admin-logo-file').files[0];
      const ref = db.collection('settings').doc('site');
      let logoUrl = null;
      if(file){
        const path = `logos/${Date.now()}_${file.name}`;
        const snap = await storage.ref(path).put(file);
        logoUrl = await snap.ref.getDownloadURL();
      }
      const payload = {};
      if(newNum) payload.managerWhats = newNum;
      if(logoUrl) payload.logo = logoUrl;
      await ref.set(payload, {merge:true});
      managerWhats = newNum || managerWhats;
      if(logoUrl) $('#logo-preview').src = logoUrl;
      $('#manager-number').innerText = managerWhats;
      alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª');
      openAdminUI();
    });
  }

  // ---------- Admin: Prop form (create/edit) ----------
  async function openPropForm(mode='create', propId=null){
    let prop = {};
    if(mode === 'edit' && propId){
      const snap = await db.collection('props').doc(propId).get(); if(!snap.exists) return alert('ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯'); prop = snap.data();
    }
    const content = `
      <h3 style="margin-top:0">${mode === 'create' ? 'Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù‚Ø§Ø± Ø¬Ø¯ÙŠØ¯' : 'ØªØ¹Ø¯ÙŠÙ„ Ø¹Ù‚Ø§Ø±'}</h3>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
        <div>
          <label>Ø§Ù„ØªØµÙ†ÙŠÙ</label>
          <select id="prop-type">${['Ø¹Ù…Ø§Ø±Ø©','ÙÙŠÙ„Ø§','Ø´Ù‚Ø©','Ø£Ø±Ø¶','Ø§Ø³ØªØ±Ø§Ø­Ø©'].map(t=>`<option ${prop.type===t? 'selected':''}>${t}</option>`).join('')}</select>
          <label>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¹Ø±Ø¶</label><input id="prop-title" value="${esc(prop.title||'')}" />
          <label>Ø§Ù„Ø³Ø¹Ø± (Ø£Ø±Ù‚Ø§Ù… Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© ÙÙ‚Ø·)</label><input id="prop-price" value="${esc(prop.price||'')}" />
          <label>Ø§Ù„Ù…Ø³Ø§Ø­Ø© (Ù…Â²)</label><input id="prop-area" value="${esc(prop.area||'')}" />
        </div>
        <div>
          <label>Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</label>
          <select id="prop-region"><option ${prop.region==='Ø´Ù…Ø§Ù„ Ø§Ù„Ø·Ø§Ø¦Ù'?'selected':''}>Ø´Ù…Ø§Ù„ Ø§Ù„Ø·Ø§Ø¦Ù</option><option ${prop.region==='Ø¬Ù†ÙˆØ¨ Ø§Ù„Ø·Ø§Ø¦Ù'?'selected':''}>Ø¬Ù†ÙˆØ¨ Ø§Ù„Ø·Ø§Ø¦Ù</option><option ${prop.region==='Ø´Ø±Ù‚ Ø§Ù„Ø·Ø§Ø¦Ù'?'selected':''}>Ø´Ø±Ù‚ Ø§Ù„Ø·Ø§Ø¦Ù</option><option ${prop.region==='ØºØ±Ø¨ Ø§Ù„Ø·Ø§Ø¦Ù'?'selected':''}>ØºØ±Ø¨ Ø§Ù„Ø·Ø§Ø¦Ù</option></select>
          <label>Ø§Ù„Ø­ÙŠ/Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</label><input id="prop-neighborhood" value="${esc(prop.neighborhood||'')}" />
          <label>Ø§Ù„ØµÙˆØ± (Ø£Ù‚ØµÙ‰ 5)</label><input type="file" id="prop-images" multiple accept="image/*" />
          <div class="images-preview" id="prop-images-preview">${(prop.images||[]).map(u=>`<div class="img-thumb"><img src="${esc(u)}"/></div>`).join('')}</div>
        </div>
      </div>
      <div style="margin-top:8px">
        <label>Ù‡Ù„ ÙŠÙˆØ¬Ø¯ ØµÙƒØŸ</label>
        <select id="prop-sak"><option value="yes" ${prop.sak? 'selected':''}>Ù†Ø¹Ù…</option><option value="no" ${!prop.sak? 'selected':''}>Ù„Ø§</option></select>
        <label style="margin-top:8px">Ù‡Ù„ ÙŠÙ‚Ø¨Ù„ Ø§Ù„Ø¨Ù†ÙƒØŸ</label>
        <select id="prop-bank"><option ${prop.bankAccepted? 'selected':''}>Ù†Ø¹Ù…</option><option ${!prop.bankAccepted? 'selected':''}>Ù„Ø§</option></select>
        <label style="margin-top:8px">Ø§Ù„ÙˆØµÙ</label>
        <textarea id="prop-desc" rows="4">${esc(prop.desc||'')}</textarea>
      </div>
      <div style="display:flex;gap:8px;margin-top:12px">
        <button class="btn" id="save-prop">${mode === 'create' ? 'Ù†Ø´Ø± Ø§Ù„Ø¹Ù‚Ø§Ø±' : 'Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„'}</button>
        <button class="btn ghost" id="cancel-prop">Ø¥Ù„ØºØ§Ø¡</button>
      </div>
    `;
    showModal(content);

    // preview images on select
    $('#prop-images').addEventListener('change', (e)=>{
      const files = Array.from(e.target.files).slice(0,5);
      const preview = $('#prop-images-preview'); preview.innerHTML = '';
      files.forEach(f=>{
        const url = URL.createObjectURL(f);
        const el = document.createElement('div'); el.className = 'img-thumb'; el.innerHTML = `<img src="${url}">`;
        preview.appendChild(el);
      });
    });

    $('#cancel-prop').addEventListener('click', hideModal);

    $('#save-prop').addEventListener('click', async ()=>{
      const payload = {
        type: $('#prop-type').value,
        title: $('#prop-title').value.trim(),
        price: $('#prop-price').value.trim(),
        area: $('#prop-area').value.trim(),
        region: $('#prop-region').value,
        neighborhood: $('#prop-neighborhood').value.trim(),
        sak: $('#prop-sak').value === 'yes',
        bankAccepted: $('#prop-bank').value === 'Ù†Ø¹Ù…',
        desc: $('#prop-desc').value.trim(),
        ownerRole: 'admin',
        ownerId: currentUser.id,
        views: 0,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      };
      // upload images then set doc
      const files = Array.from($('#prop-images').files).slice(0,5);
      if(files.length){
        const uploaded = [];
        for(let i=0;i<files.length;i++){
          const file = files[i];
          const path = `props/${Date.now()}_${file.name}`;
          const snap = await storage.ref(path).put(file);
          const url = await snap.ref.getDownloadURL();
          uploaded.push(url);
        }
        payload.images = uploaded;
      } else if(mode === 'edit' && (prop.images||[]).length) {
        payload.images = prop.images;
      } else {
        payload.images = [];
      }

      if(mode === 'create'){
        await db.collection('props').add(payload);
        alert('ØªÙ… Ù†Ø´Ø± Ø§Ù„Ø¹Ù‚Ø§Ø±');
      } else {
        await db.collection('props').doc(propId).update(payload);
        alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª');
      }
      hideModal(); openAdminUI(); loadCards();
    });
  }

  // ---------- Admin: Broker form (create/edit) ----------
  async function openBrokerForm(mode='create', brokerId=null){
    let broker = {};
    if(mode === 'edit' && brokerId){
      const snap = await db.collection('users').doc(brokerId).get(); if(!snap.exists) return alert('ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯'); broker = snap.data();
    }
    const content = `
      <h3 style="margin-top:0">${mode === 'create' ? 'Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ ÙˆØ³ÙŠØ·' : 'ØªØ¹Ø¯ÙŠÙ„ Ø­Ø³Ø§Ø¨ ÙˆØ³ÙŠØ·'}</h3>
      <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label><input id="broker-username" value="${esc(broker.username||'')}" />
      <label style="margin-top:6px">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label><input id="broker-password" value="${esc(broker.password||'')}" />
      <label style="margin-top:6px">Ø±Ù‚Ù… ÙˆØ§ØªØ³Ø§Ø¨</label><input id="broker-whatsapp" value="${esc(broker.whatsapp||'')}" />
      <div style="display:flex;gap:8px;margin-top:12px">
        <button class="btn" id="save-broker">${mode === 'create' ? 'Ø¥Ù†Ø´Ø§Ø¡' : 'Ø­ÙØ¸'}</button>
        <button class="btn ghost" id="cancel-broker">Ø¥Ù„ØºØ§Ø¡</button>
      </div>
    `;
    showModal(content);

    $('#cancel-broker').addEventListener('click', hideModal);
    $('#save-broker').addEventListener('click', async ()=>{
      const u = $('#broker-username').value.trim(); const p = $('#broker-password').value.trim(); const w = $('#broker-whatsapp').value.trim();
      if(!u || !p){ alert('Ø§Ø¯Ø®Ù„ Ø§Ø³Ù… Ù…Ø³ØªØ®Ø¯Ù… ÙˆÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ±'); return; }
      if(mode === 'create'){
        await db.collection('users').add({username:u, password:p, role:'broker', active:true, whatsapp:w, createdAt: firebase.firestore.FieldValue.serverTimestamp()});
        alert('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙˆØ³ÙŠØ·');
      } else {
        await db.collection('users').doc(brokerId).update({username:u,password:p,whatsapp:w});
        alert('ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«');
      }
      hideModal(); openAdminUI();
    });
  }

  // ---------- Broker UI ----------
  async function openBrokerUI(){
    const propsSnap = await db.collection('props').where('ownerId','==', currentUser.id).orderBy('createdAt','desc').get();
    const props = []; propsSnap.forEach(d=> props.push({id:d.id,...d.data()}));
    const content = `
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3 style="margin:0">Ù„ÙˆØ­Ø© Ø§Ù„ÙˆØ³ÙŠØ· â€” ${esc(currentUser.username)}</h3>
        <div><button class="btn ghost" id="broker-logout">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button></div>
      </div>
      <div style="margin-top:12px;display:grid;grid-template-columns:1fr 320px;gap:12px">
        <div>
          <div style="background:#fff;padding:12px;border-radius:12px">
            <h4 style="margin:0 0 8px 0">Ø¹Ù‚Ø§Ø±Ø§ØªÙŠ</h4>
            <div style="margin-bottom:8px"><button class="btn" id="broker-add-prop">Ø¥Ø¶Ø§ÙØ© Ø¹Ù‚Ø§Ø±</button></div>
            <table class="table"><thead><tr><th>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th><th>Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</th><th>Ø§Ù„Ø³Ø¹Ø±</th><th>Ø£ÙØ¹Ø§Ù„</th></tr></thead><tbody>${props.map(p=>`<tr data-id="${p.id}"><td>${esc(p.title)}</td><td>${esc(p.region)}</td><td>${fmt(p.price)}</td><td><button class="btn small broker-edit" data-id="${p.id}">ØªØ¹Ø¯ÙŠÙ„</button> <button class="btn small ghost broker-del" data-id="${p.id}">Ø­Ø°Ù</button></td></tr>`).join('')}</tbody></table>
          </div>
        </div>
        <aside>
          <div style="background:#fff;padding:12px;border-radius:12px">
            <h4 style="margin:0 0 8px 0">Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</h4>
            <div>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: <b>${esc(currentUser.username)}</b></div>
            <div style="margin-top:8px"><label>Ø±Ù‚Ù… ÙˆØ§ØªØ³Ø§Ø¨</label><input id="broker-ws" value="${esc(currentUser.whatsapp||'')}" /></div>
            <div style="margin-top:12px;display:flex;gap:8px">
              <button class="btn" id="save-broker-ws">Ø­ÙØ¸</button>
              <button class="btn ghost" id="close-broker">Ø¥ØºÙ„Ø§Ù‚</button>
            </div>
          </div>
        </aside>
      </div>
    `;
    showModal(content);
    $('#broker-logout').addEventListener('click', ()=>{ currentUser = null; hideModal(); alert('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬'); });
    $('#close-broker').addEventListener('click', hideModal);
    $('#save-broker-ws').addEventListener('click', async ()=>{ const w = $('#broker-ws').value.trim(); await db.collection('users').doc(currentUser.id).update({whatsapp:w}); currentUser.whatsapp = w; alert('ØªÙ… Ø­ÙØ¸ Ø±Ù‚Ù… Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨'); openBrokerUI(); });

    // add prop
    $('#broker-add-prop').addEventListener('click', ()=> openBrokerAddPropForm());

    // edit/delete
    $$('.broker-edit').forEach(btn => btn.addEventListener('click', e => openBrokerEditPropForm(e.currentTarget.dataset.id)));
    $$('.broker-del').forEach(btn => btn.addEventListener('click', async e => {
      const id = e.currentTarget.dataset.id;
      if(!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù‚Ø§Ø±ØŸ')) return;
      await db.collection('props').doc(id).delete();
      alert('ØªÙ… Ø§Ù„Ø­Ø°Ù'); openBrokerUI(); loadCards();
    }));
  }

  async function openBrokerAddPropForm(){
    const content = `
      <h3 style="margin-top:0">Ø¥Ø¶Ø§ÙØ© Ø¹Ù‚Ø§Ø± Ø¬Ø¯ÙŠØ¯</h3>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
        <div>
          <label>Ø§Ù„ØªØµÙ†ÙŠÙ</label><select id="b-prop-type"><option>ÙÙŠÙ„Ø§</option><option>Ø´Ù‚Ø©</option><option>Ø¹Ù…Ø§Ø±Ø©</option><option>Ø£Ø±Ø¶</option><option>Ø§Ø³ØªØ±Ø§Ø­Ø©</option></select>
          <label>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¹Ø±Ø¶</label><input id="b-prop-title" />
          <label>Ø§Ù„Ø³Ø¹Ø±</label><input id="b-prop-price" />
          <label>Ø§Ù„Ù…Ø³Ø§Ø­Ø©</label><input id="b-prop-area" />
        </div>
        <div>
          <label>Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</label><select id="b-prop-region"><option>Ø´Ù…Ø§Ù„ Ø§Ù„Ø·Ø§Ø¦Ù</option><option>Ø¬Ù†ÙˆØ¨ Ø§Ù„Ø·Ø§Ø¦Ù</option><option>Ø´Ø±Ù‚ Ø§Ù„Ø·Ø§Ø¦Ù</option><option>ØºØ±Ø¨ Ø§Ù„Ø·Ø§Ø¦Ù</option></select>
          <label>Ø§Ù„Ø­ÙŠ/Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</label><input id="b-prop-neigh" />
          <label>Ø§Ù„ØµÙˆØ± (Ø£Ù‚ØµÙ‰ 5)</label><input type="file" id="b-prop-images" multiple accept="image/*" />
          <div class="images-preview" id="b-prop-preview"></div>
        </div>
      </div>
      <div style="margin-top:8px"><label>Ø§Ù„ØµÙƒ</label><select id="b-prop-sak"><option value="yes">Ù†Ø¹Ù…</option><option value="no">Ù„Ø§</option></select></div>
      <div style="margin-top:8px"><label>Ø§Ù„ÙˆØµÙ</label><textarea id="b-prop-desc" rows="4"></textarea></div>
      <div style="display:flex;gap:8px;margin-top:12px"><button class="btn" id="b-save-prop">Ù†Ø´Ø±</button><button class="btn ghost" id="b-cancel">Ø¥Ù„ØºØ§Ø¡</button></div>
    `;
    showModal(content);
    $('#b-prop-preview').innerHTML = '';
    $('#b-prop-images').addEventListener('change', (e)=>{
      const files = Array.from(e.target.files).slice(0,5);
      const preview = $('#b-prop-preview'); preview.innerHTML = '';
      files.forEach(f=>{ const url = URL.createObjectURL(f); const el = document.createElement('div'); el.className='img-thumb'; el.innerHTML = `<img src="${url}">`; preview.appendChild(el); });
    });
    $('#b-cancel').addEventListener('click', hideModal);
    $('#b-save-prop').addEventListener('click', async ()=>{
      const payload = {
        type: $('#b-prop-type').value,
        title: $('#b-prop-title').value.trim(),
        price: $('#b-prop-price').value.trim(),
        area: $('#b-prop-area').value.trim(),
        region: $('#b-prop-region').value,
        neighborhood: $('#b-prop-neigh').value.trim(),
        sak: $('#b-prop-sak').value === 'yes',
        bankAccepted: false,
        desc: $('#b-prop-desc').value.trim(),
        ownerRole: 'broker', ownerId: currentUser.id,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(), views:0
      };
      const files = Array.from($('#b-prop-images').files).slice(0,5);
      const uploaded = [];
      for(let f of files){
        const path = `props/${Date.now()}_${f.name}`;
        const snap = await storage.ref(path).put(f);
        const url = await snap.ref.getDownloadURL();
        uploaded.push(url);
      }
      payload.images = uploaded;
      await db.collection('props').add(payload);
      alert('ØªÙ… Ø§Ù„Ù†Ø´Ø±'); hideModal(); openBrokerUI(); loadCards();
    });
  }

  async function openBrokerEditPropForm(propId){
    const doc = await db.collection('props').doc(propId).get(); if(!doc.exists) return alert('ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯'); const p = doc.data();
    const content = `
      <h3 style="margin-top:0">ØªØ¹Ø¯ÙŠÙ„ Ø¹Ù‚Ø§Ø±</h3>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
        <div>
          <label>Ø§Ù„ØªØµÙ†ÙŠÙ</label><select id="eb-prop-type">${['Ø¹Ù…Ø§Ø±Ø©','ÙÙŠÙ„Ø§','Ø´Ù‚Ø©','Ø£Ø±Ø¶','Ø§Ø³ØªØ±Ø§Ø­Ø©'].map(t=>`<option ${p.type===t? 'selected':''}>${t}</option>`).join('')}</select>
          <label>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¹Ø±Ø¶</label><input id="eb-prop-title" value="${esc(p.title||'')}" />
          <label>Ø§Ù„Ø³Ø¹Ø±</label><input id="eb-prop-price" value="${esc(p.price||'')}" />
          <label>Ø§Ù„Ù…Ø³Ø§Ø­Ø©</label><input id="eb-prop-area" value="${esc(p.area||'')}" />
        </div>
        <div>
          <label>Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</label><select id="eb-prop-region"><option ${p.region==='Ø´Ù…Ø§Ù„ Ø§Ù„Ø·Ø§Ø¦Ù'?'selected':''}>Ø´Ù…Ø§Ù„ Ø§Ù„Ø·Ø§Ø¦Ù</option><option ${p.region==='Ø¬Ù†ÙˆØ¨ Ø§Ù„Ø·Ø§Ø¦Ù'?'selected':''}>Ø¬Ù†ÙˆØ¨ Ø§Ù„Ø·Ø§Ø¦Ù</option><option ${p.region==='Ø´Ø±Ù‚ Ø§Ù„Ø·Ø§Ø¦Ù'?'selected':''}>Ø´Ø±Ù‚ Ø§Ù„Ø·Ø§Ø¦Ù</option><option ${p.region==='ØºØ±Ø¨ Ø§Ù„Ø·Ø§Ø¦Ù'?'selected':''}>ØºØ±Ø¨ Ø§Ù„Ø·Ø§Ø¦Ù</option></select>
          <label>Ø§Ù„Ø­ÙŠ</label><input id="eb-prop-neigh" value="${esc(p.neighborhood||'')}" />
          <label>Ø§Ù„ØµÙˆØ± (Ø¥Ø¶Ø§ÙØ©/Ø§Ø³ØªØ¨Ø¯Ø§Ù„)</label><input type="file" id="eb-prop-images" multiple accept="image/*"/>
          <div class="images-preview" id="eb-prop-preview">${(p.images||[]).map(u=>`<div class="img-thumb"><img src="${esc(u)}"/></div>`).join('')}</div>
        </div>
      </div>
      <div style="margin-top:8px"><label>Ø§Ù„ØµÙƒ</label><select id="eb-prop-sak"><option value="yes" ${p.sak? 'selected':''}>Ù†Ø¹Ù…</option><option value="no" ${!p.sak? 'selected':''}>Ù„Ø§</option></select></div>
      <div style="margin-top:8px"><label>Ø§Ù„ÙˆØµÙ</label><textarea id="eb-prop-desc" rows="4">${esc(p.desc||'')}</textarea></div>
      <div style="display:flex;gap:8px;margin-top:12px"><button class="btn" id="eb-save">Ø­ÙØ¸</button><button class="btn ghost" id="eb-cancel">Ø¥Ù„ØºØ§Ø¡</button></div>
    `;
    showModal(content);
    $('#eb-prop-images').addEventListener('change', (e)=>{
      const files = Array.from(e.target.files).slice(0,5);
      const prev = $('#eb-prop-preview'); prev.innerHTML = '';
      files.forEach(f=>{ const url = URL.createObjectURL(f); const el = document.createElement('div'); el.className='img-thumb'; el.innerHTML = `<img src="${url}">`; prev.appendChild(el); });
    });
    $('#eb-cancel').addEventListener('click', hideModal);
    $('#eb-save').addEventListener('click', async ()=>{
      const payload = {
        type: $('#eb-prop-type').value,
        title: $('#eb-prop-title').value.trim(),
        price: $('#eb-prop-price').value.trim(),
        area: $('#eb-prop-area').value.trim(),
        region: $('#eb-prop-region').value,
        neighborhood: $('#eb-prop-neigh').value.trim(),
        sak: $('#eb-prop-sak').value === 'yes',
        desc: $('#eb-prop-desc').value.trim()
      };
      const files = Array.from($('#eb-prop-images').files).slice(0,5);
      if(files.length){
        const uploaded = [];
        for(let f of files){
          const path = `props/${Date.now()}_${f.name}`;
          const snap = await storage.ref(path).put(f);
          const url = await snap.ref.getDownloadURL();
          uploaded.push(url);
        }
        payload.images = uploaded;
      }
      await db.collection('props').doc(propId).update(payload);
      alert('ØªÙ… Ø§Ù„Ø­ÙØ¸'); hideModal(); openBrokerUI(); loadCards();
    });
  }

  // ---------- init ----------
  (async ()=>{
    await ensureDefaults();
    await loadCards();
  })();
  </script>
</body>
</html>
