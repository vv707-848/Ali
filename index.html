<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>النخبة العقارية — منصة احترافية</title>
  <meta name="description" content="النخبة العقارية — منصة عقارية احترافية للبيع. تواصل عبر واتساب مباشرة مع الوسيط أو المدير.">
  <style>
    /* ---------------- Design (modern, RTL, professional) ---------------- */
    :root{
      --bg: #0f172a10;
      --card: #ffffff;
      --muted: #6b7280;
      --accent: #0b6cf5;
      --accent-2: #0b87ff;
      --glass: rgba(255,255,255,0.75);
      --danger: #ef4444;
      --success: #16a34a;
      --radius: 14px;
      font-family: Inter, "Noto Sans Arabic", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#f3f7ff 0%, #f7fbff 50%);color:#0b1220}
    a{color:inherit;text-decoration:none}
    /* header */
    header{position:sticky;top:0;z-index:90;background:rgba(255,255,255,0.9);backdrop-filter:blur(6px);border-bottom:1px solid #eef4ff;padding:12px 24px;display:flex;align-items:center;gap:16px}
    .container{max-width:1200px;margin:18px auto;padding:0 18px}
    .logo{display:flex;align-items:center;gap:12px}
    .logo img{width:56px;height:56px;border-radius:12px;object-fit:cover;box-shadow:0 6px 20px rgba(11,108,245,0.06)}
    .brand-title{font-weight:800;font-size:18px}
    .brand-sub{color:var(--muted);font-size:13px}
    .top-actions{margin-left:auto;display:flex;gap:10px;align-items:center}

    /* button */
    .btn{display:inline-flex;gap:8px;align-items:center;padding:10px 14px;border-radius:12px;border:0;cursor:pointer;background:var(--accent);color:white;font-weight:700;box-shadow:0 8px 30px rgba(11,108,245,0.08)}
    .btn.ghost{background:transparent;color:var(--accent);border:1px solid rgba(11,108,245,0.12);box-shadow:none}
    .btn.small{padding:8px 10px;border-radius:10px;font-weight:700}

    /* hero & search */
    .hero{display:flex;gap:18px;align-items:stretch;margin-top:18px}
    .search-panel{flex:1;background:linear-gradient(180deg,#fff,#f8fbff);padding:18px;border-radius:16px;box-shadow:0 12px 40px rgba(2,6,23,0.06)}
    .search-row{display:flex;gap:10px;align-items:center}
    input,select,textarea{padding:12px;border-radius:10px;border:1px solid #eef3ff;font-size:15px}
    input::placeholder{color:#9aa4c4}
    .cats{display:flex;gap:12px;margin-top:12px;flex-wrap:wrap}

    /* layout */
    .grid{display:grid;grid-template-columns:1fr 360px;gap:20px;margin-top:20px}
    .cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:18px}
    .card{background:var(--card);border-radius:12px;overflow:hidden;display:flex;flex-direction:column;transition:transform .18s,box-shadow .18s;box-shadow:0 10px 30px rgba(2,6,23,0.06)}
    .card:hover{transform:translateY(-8px);box-shadow:0 20px 60px rgba(2,6,23,0.09)}
    .thumb{height:180px;background:linear-gradient(90deg,#eef6ff,#f8fbff);display:flex;align-items:center;justify-content:center}
    .thumb img{width:100%;height:100%;object-fit:cover}
    .card-body{padding:12px;display:flex;flex-direction:column;gap:8px}
    .price{color:var(--accent);font-weight:900;font-size:16px}
    .meta{color:var(--muted);font-size:13px}
    .card-actions{display:flex;gap:8px;padding:12px;border-top:1px solid #f3f6fb}

    /* aside */
    .panel{background:linear-gradient(180deg,#fff,#fcfeff);padding:12px;border-radius:12px;box-shadow:0 12px 36px rgba(2,6,23,0.06)}
    .stat-row{display:flex;gap:12px;align-items:center;justify-content:space-between}

    /* modal (forms) */
    .modal-back{position:fixed;inset:0;background:rgba(2,6,23,0.5);display:none;align-items:center;justify-content:center;z-index:120}
    .modal{width:940px;max-width:95%;background:var(--card);border-radius:14px;padding:18px;box-shadow:0 30px 80px rgba(2,6,23,0.2);max-height:90vh;overflow:auto}
    .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .full{grid-column:1/-1}

    /* dashboard */
    .dashboard{display:flex;gap:18px;align-items:flex-start}
    .sidebar{min-width:260px;background:var(--card);padding:12px;border-radius:12px;box-shadow:0 12px 36px rgba(2,6,23,0.06)}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{padding:8px;border-bottom:1px solid #f3f6fb;text-align:right;font-size:13px}

    /* uploader preview */
    .images-preview{display:flex;gap:8px;flex-wrap:wrap}
    .img-thumb{width:100px;height:70px;border-radius:8px;overflow:hidden;box-shadow:0 6px 20px rgba(2,6,23,0.06)}
    .img-thumb img{width:100%;height:100%;object-fit:cover}

    /* responsive */
    @media(max-width:980px){ .grid{grid-template-columns:1fr} .hero{flex-direction:column} .sidebar{display:none} }
  </style>
</head>
<body>
  <header>
    <div class="container" style="display:flex;align-items:center;">
      <div class="logo">
        <img id="logo-preview" src="" alt="logo">
        <div>
          <div class="brand-title">النخبة العقارية</div>
          <div class="brand-sub">منصة احترافية للبيع — تواصل عبر واتساب</div>
        </div>
      </div>
      <div class="top-actions">
        <button class="btn ghost" id="btn-home">الصفحة الرئيسية</button>
        <button class="btn" id="btn-open-login">تسجيل دخول</button>
      </div>
    </div>
  </header>

  <main class="container">
    <!-- HERO / SEARCH -->
    <section class="hero">
      <div class="search-panel">
        <h2 style="margin:0 0 6px 0">ابحث عن عقارك التالي</h2>
        <p style="margin:0 0 12px;color:var(--muted)">فلتر شامل وسهل — اختر النوع، المنطقة، أو اكتب ما تريد.</p>

        <div class="search-row">
          <input id="q" placeholder="مثال: فيلا فاخرة، الحوية، 1500000"/>
          <select id="filter-type"><option value="">كل الأقسام</option><option>فيلا</option><option>شقة</option><option>عمارة</option><option>أرض</option><option>استراحة</option></select>
          <select id="filter-region"><option value="">كل المناطق</option><option>شمال الطائف</option><option>جنوب الطائف</option><option>شرق الطائف</option><option>غرب الطائف</option></select>
          <button class="btn" id="btn-search">ابحث</button>
        </div>

        <div class="cats" style="margin-top:12px">
          <div class="cat" data-type="فيلا">🏡 فيلا</div>
          <div class="cat" data-type="شقة">🏘 شقة</div>
          <div class="cat" data-type="عمارة">🏢 عمارة</div>
          <div class="cat" data-type="أرض">🟩 أرض</div>
          <div class="cat" data-type="استراحة">🌴 استراحة</div>
        </div>
      </div>

      <aside style="width:360px">
        <div class="panel">
          <h3 style="margin-top:0">لم أجد العقار المناسب</h3>
          <p style="color:var(--muted)">اضغط وسنتواصل معك شخصياً.</p>
          <button class="btn" id="not-found">لم أجد العقار المناسب</button>
          <hr style="margin:12px 0;border:none;border-top:1px dashed #eef4ff">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <div class="meta">اتصل بالمدير</div>
              <div style="font-weight:800;margin-top:6px" id="manager-number">0535342404</div>
            </div>
            <div style="text-align:left">
              <small class="meta">يوزر تجريبي</small>
              <div style="font-weight:800">IVL511</div>
            </div>
          </div>
        </div>
      </aside>
    </section>

    <!-- main grid -->
    <section class="grid">
      <section>
        <div id="cards" class="cards" aria-live="polite"></div>
      </section>

      <aside class="sidebar">
        <div style="display:flex;flex-direction:column;gap:12px">
          <div>
            <h4 style="margin:0 0 6px 0">الإحصائيات</h4>
            <div class="stat-row">
              <div><div style="font-weight:800" id="stat-props">0</div><div class="meta">إجمالي العقارات</div></div>
              <div><div style="font-weight:800" id="stat-brokers">0</div><div class="meta">إجمالي الوسطاء</div></div>
            </div>
          </div>

          <div>
            <h4 style="margin:0 0 6px 0">إدارة سريعة</h4>
            <button class="btn small" id="open-admin">لوحة المدير</button>
            <button class="btn small ghost" id="open-broker">لوحة الوسيط</button>
          </div>

          <div>
            <h4 style="margin:0 0 6px 0">أقسام سريعة</h4>
            <div style="display:flex;flex-direction:column;gap:8px">
              <div class="cat" data-type="فيلا">🏡 فيلا</div>
              <div class="cat" data-type="شقة">🏘 شقة</div>
              <div class="cat" data-type="أرض">🟩 أرض</div>
            </div>
          </div>
        </div>
      </aside>
    </section>
  </main>

  <!-- MODAL: Login / Admin / Broker / Forms -->
  <div class="modal-back" id="modal-back">
    <div class="modal" id="modal">
      <!-- content injected by JS -->
    </div>
  </div>

  <footer style="text-align:center;color:var(--muted);margin:28px 0">© النخبة العقارية</footer>

  <!-- Firebase SDK (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>

  <script>
  /**************************************************************************
   * النخبة العقارية — Single-file app
   * - واجهة عامة لعرض العقارات
   * - لوحة مدير واجهة رسومية كاملة (إضافة/تعديل/حذف وسطاء وعقارات)
   * - لوحة وسيط لإدارة عقاراته وملفه الشخصي
   * - رفع صور إلى Firebase Storage، بيانات محفوظة في Firestore
   * - منطق واتساب: عقارات المدير -> مدير (0535342404)، عقارات الوسيط -> رقم الوسيط المسجل
   *
   * ملاحظة أمان: هذا مثال جاهز للتشغيل. قبل الإنتاج:
   * - نفّذ Firebase Auth + قواعد Firestore/Storage مناسبة
   * - لا تخزن كلمات المرور نصاً عاديًا في الإنتاج (هنا للسهولة والتجربة)
   **************************************************************************/

  // ---------- Firebase config (provided) ----------
  const firebaseConfig = {
    apiKey: "AIzaSyApEkbNuWz1nd0DSwt4lirlVlUSt3GNB0Y",
    authDomain: "alnokhbu.firebaseapp.com",
    projectId: "alnokhbu",
    storageBucket: "alnokhbu.firebasestorage.app",
    messagingSenderId: "647865484582",
    appId: "1:647865484582:web:162d57ee1dfab160c9ede7",
    measurementId: "G-GMZB6BG3LY"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const storage = firebase.storage();

  // ---------- App state ----------
  let managerWhats = '0535342404';
  let currentUser = null; // {id, username, role: 'admin'|'broker', whatsapp, active}
  let modalBack = document.getElementById('modal-back');
  let modal = document.getElementById('modal');

  // ---------- utils ----------
  const $ = (s) => document.querySelector(s);
  const $$ = (s) => Array.from(document.querySelectorAll(s));
  const esc = s => (s||'').toString().replace(/[&<>\"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  const fmt = n => (n||'').toString().replace(/(\\d)(?=(\\d{3})+$)/g,'$1,');
  const normPhone = n => (n||'').toString().replace(/[^0-9]/g,'');

  // ---------- UI wiring ----------
  document.getElementById('btn-open-login').addEventListener('click', openLoginModal);
  document.getElementById('btn-home').addEventListener('click', ()=>{ hideModal(); loadCards(); $('#detail-view') && ($('#detail-view').style.display='none'); });
  document.getElementById('open-admin').addEventListener('click', openLoginModal);
  document.getElementById('open-broker').addEventListener('click', openLoginModal);
  document.getElementById('btn-search').addEventListener('click', ()=> loadCards({q:$('#q').value, type:$('#filter-type').value, region:$('#filter-region').value}));
  $$('.cat').forEach(c=>c.addEventListener('click', e => { $('#filter-type').value = e.currentTarget.dataset.type; loadCards({type: e.currentTarget.dataset.type}); }));
  document.getElementById('not-found').addEventListener('click', ()=> {
    const msg = 'مرحباً، بحثت في موقع النخبة العقارية ولم أجد العقار الذي أبحث عنه.';
    window.open(`https://wa.me/${normPhone(managerWhats)}?text=${encodeURIComponent(msg)}`, '_blank');
  });

  // ---------- modal helpers ----------
  function showModal(contentHtml){
    modal.innerHTML = contentHtml;
    modalBack.style.display = 'flex';
  }
  function hideModal(){ modalBack.style.display = 'none'; modal.innerHTML = ''; }

  modalBack.addEventListener('click', (e) => { if(e.target === modalBack) hideModal(); });

  // ---------- Defaults on first run ----------
  async function ensureDefaults(){
    // settings
    const setRef = db.collection('settings').doc('site');
    const setSnap = await setRef.get();
    if(!setSnap.exists){
      await setRef.set({managerWhats:'0535342404', logo:'', createdAt: firebase.firestore.FieldValue.serverTimestamp()});
      managerWhats = '0535342404';
    } else {
      const data = setSnap.data();
      managerWhats = data.managerWhats || managerWhats;
      if(data.logo) $('#logo-preview').src = data.logo;
    }
    $('#manager-number').innerText = managerWhats;

    // default admin user
    const q = await db.collection('users').where('username','==','IVL511').get();
    if(q.empty){
      await db.collection('users').add({username:'IVL511', password:'IVL511', role:'admin', active:true, whatsapp: managerWhats, createdAt: firebase.firestore.FieldValue.serverTimestamp()});
    }

    // if no props, add sample
    const propsSnap = await db.collection('props').limit(1).get();
    if(propsSnap.empty){
      await db.collection('props').add({
        type:'فيلا', title:'فيلا فاخرة للبيع', price:'1500000', area:'500',
        region:'شمال الطائف', neighborhood:'الحوية', sak:true, bankAccepted:true, desc:'فيلا فاخرة بمواصفات عالية في موقع مميز.',
        images:[], ownerRole:'admin', ownerId:null, createdAt: firebase.firestore.FieldValue.serverTimestamp(), views:0
      });
    }
  }

  // ---------- Render public cards ----------
  async function loadCards(filter = {}){
    const snap = await db.collection('props').orderBy('createdAt','desc').get();
    const all = []; snap.forEach(d=> all.push({id:d.id, ...d.data()}));
    const qtext = (filter.q||'').toString().toLowerCase();
    const filtered = all.filter(p=>{
      if(filter.type && filter.type !== p.type) return false;
      if(filter.region && filter.region !== p.region) return false;
      if(qtext && !((p.title||'').toLowerCase().includes(qtext) || (p.neighborhood||'').toLowerCase().includes(qtext) || (p.desc||'').toLowerCase().includes(qtext))) return false;
      return true;
    });

    $('#cards').innerHTML = '';
    if(!filtered.length){ $('#cards').innerHTML = '<div style="padding:18px;background:#fff;border-radius:12px">لا توجد عروض حالياً</div>'; return; }

    filtered.forEach(p=>{
      const img = (p.images && p.images.length) ? p.images[0] : '';
      const div = document.createElement('div'); div.className = 'card';
      div.innerHTML = `
        <div class="thumb">${ img ? `<img src="${esc(img)}" alt="${esc(p.title)}">` : '<div style="padding:14px;color:var(--muted)">لا توجد صورة</div>' }</div>
        <div class="card-body">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <div class="price">${fmt(p.price)} ر.س</div>
              <div style="font-weight:800">${esc(p.title)}</div>
            </div>
            <div style="text-align:left">
              <div class="meta">${esc(p.region)}</div>
              <div class="meta">${esc(p.area)} م²</div>
            </div>
          </div>
          <div class="meta">${esc(p.neighborhood) || ''}</div>
        </div>
        <div class="card-actions">
          <button class="btn small detail-btn" data-id="${p.id}">عرض التفاصيل</button>
          <button class="btn small ghost contact-btn" data-id="${p.id}">واتساب</button>
        </div>`;
      $('#cards').appendChild(div);
    });

    // events
    $$('.detail-btn').forEach(b => b.addEventListener('click', e => showDetail(e.currentTarget.dataset.id)));
    $$('.contact-btn').forEach(b => b.addEventListener('click', e => contactFromCard(e.currentTarget.dataset.id)));

    // stats:
    const statsP = await db.collection('props').get(); $('#stat-props').innerText = statsP.size;
    const statsB = await db.collection('users').where('role','==','broker').get(); $('#stat-brokers').innerText = statsB.size;
  }

  // ---------- Detail view ----------
  async function showDetail(id){
    const doc = await db.collection('props').doc(id).get();
    if(!doc.exists) return alert('العرض غير موجود');
    const p = {id: doc.id, ...doc.data()};
    // increment views
    await db.collection('props').doc(id).update({views: (p.views||0)+1});
    // render in modal
    let imagesHtml = '';
    (p.images || []).forEach(u => imagesHtml += `<img src="${esc(u)}" style="height:160px;border-radius:10px;margin-right:8px">`);
    const content = `
      <h3 style="margin-top:0">${esc(p.title)}</h3>
      <div style="display:flex;gap:12px;align-items:center;justify-content:space-between">
        <div><div class="price">${fmt(p.price)} ر.س</div><div class="meta">${esc(p.region)} — ${esc(p.neighborhood)}</div></div>
        <div style="text-align:left"><div class="meta">المساحة</div><div style="font-weight:800">${esc(p.area)} م²</div></div>
      </div>
      <div style="margin-top:12px">${imagesHtml || '<div style="padding:14px;background:#f1f7ff;border-radius:10px">لا توجد صور</div>'}</div>
      <p style="margin-top:12px;color:#263248">${esc(p.desc)}</p>
      <table style="width:100%;margin-top:8px"><tbody>
        <tr><th style="text-align:right;padding:8px">الصك</th><td>${p.sak? 'نعم':'لا'}</td></tr>
        <tr><th style="text-align:right;padding:8px">يقبل بنك</th><td>${p.bankAccepted? 'نعم':'لا'}</td></tr>
        <tr><th style="text-align:right;padding:8px">معروض بواسطة</th><td>${p.ownerRole === 'broker' ? 'وسيط' : 'مدير'}</td></tr>
      </tbody></table>
      <div style="display:flex;gap:10px;margin-top:12px">
        <button class="btn" id="modal-contact">التواصل عبر واتساب</button>
        <button class="btn ghost" id="modal-close">إغلاق</button>
      </div>`;
    showModal(content);
    $('#modal-contact').addEventListener('click', ()=> {
      contactFromData(p);
    });
    $('#modal-close').addEventListener('click', hideModal);
  }

  // ---------- WhatsApp contact logic ----------
  async function contactFromCard(id){
    const doc = await db.collection('props').doc(id).get(); if(!doc.exists) return alert('العرض غير موجود');
    const p = {id: doc.id, ...doc.data()};
    contactFromData(p);
  }
  async function contactFromData(p){
    let target = managerWhats;
    if(p.ownerRole === 'broker' && p.ownerId){
      const bdoc = await db.collection('users').doc(p.ownerId).get();
      if(bdoc.exists){ const b = bdoc.data(); if(b.whatsapp) target = b.whatsapp; }
    }
    const msg = `مرحباً، أرغب بالاستفسار عن العقار المعروض لديكم في موقع (النخبة العقارية):%0Aالعرض: ${encodeURIComponent(p.title)}%0Aالسعر: ${encodeURIComponent(p.price)} ريال%0Aالمساحة: ${encodeURIComponent(p.area)} م²%0Aالرابط: ${encodeURIComponent(location.href)}%0Aهل العقار لازال متاحاً؟`;
    window.open(`https://wa.me/${normPhone(target)}?text=${msg}`, '_blank');
  }

  // ---------- Login Modal & Auth (simple using users collection) ----------
  function openLoginModal(){
    const html = `
      <h3 style="margin-top:0">تسجيل الدخول</h3>
      <div style="display:flex;gap:12px">
        <div style="flex:1">
          <label>اسم المستخدم</label>
          <input id="login-username" placeholder="اسم المستخدم (مثال IVL511)"/>
          <label style="margin-top:8px">كلمة المرور</label>
          <input id="login-password" type="password" placeholder="كلمة المرور"/>
          <div style="margin-top:12px;display:flex;gap:8px">
            <button class="btn" id="do-login">دخول</button>
            <button class="btn ghost" id="cancel-login">إلغاء</button>
          </div>
          <div id="login-msg" style="color:var(--danger);margin-top:8px"></div>
          <div style="margin-top:8px;color:var(--muted);font-size:13px">يوزر افتراضي: <b>IVL511</b> / كلمة: <b>IVL511</b></div>
        </div>
        <div style="width:280px">
          <div style="background:#f6f9ff;padding:12px;border-radius:10px">
            <h4 style="margin:0 0 6px 0">لماذا الدخول؟</h4>
            <p style="margin:0;color:var(--muted)">لوحة المدير تتيح إضافة/تعديل/حذف الوسطاء والعقارات. الوسيط يدير عقاراته فقط.</p>
          </div>
        </div>
      </div>`;
    showModal(html);
    $('#do-login').addEventListener('click', async ()=>{
      const u = $('#login-username').value.trim();
      const p = $('#login-password').value.trim();
      if(!u || !p){ $('#login-msg').innerText = 'الرجاء ملء الحقول'; return; }
      const q = await db.collection('users').where('username','==',u).where('password','==',p).where('active','==',true).get();
      if(q.empty){ $('#login-msg').innerText = 'بيانات غير صحيحة أو الحساب موقوف'; return; }
      const doc = q.docs[0]; currentUser = {id: doc.id, ...doc.data()};
      hideModal();
      if(currentUser.role === 'admin') openAdminUI();
      else openBrokerUI();
    });
    $('#cancel-login').addEventListener('click', hideModal);
  }

  // ---------- Admin UI (full GUI inside modal) ----------
  async function openAdminUI(){
    // load data
    const propsSnap = await db.collection('props').orderBy('createdAt','desc').get();
    const props = []; propsSnap.forEach(d => props.push({id:d.id,...d.data()}));
    const brokersSnap = await db.collection('users').where('role','==','broker').get();
    const brokers = []; brokersSnap.forEach(d => brokers.push({id:d.id,...d.data()}));
    const content = `
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3 style="margin:0">لوحة المدير — ${esc(currentUser.username)}</h3>
        <div><button class="btn ghost" id="admin-logout">تسجيل خروج</button></div>
      </div>
      <div style="margin-top:12px;display:grid;grid-template-columns:1fr 380px;gap:12px">
        <div>
          <div style="background:#fff;padding:12px;border-radius:12px"><h4 style="margin:0 0 8px 0">إدارة العقارات</h4>
            <table class="table" style="width:100%"><thead><tr><th>العنوان</th><th>المنطقة</th><th>السعر</th><th>المالك</th><th>أفعال</th></tr></thead><tbody id="admin-props-rows">${props.map(p=>`<tr data-id="${p.id}"><td>${esc(p.title)}</td><td>${esc(p.region)} - ${esc(p.neighborhood)}</td><td>${fmt(p.price)}</td><td>${p.ownerRole}</td><td><button class="btn small admin-edit-prop" data-id="${p.id}">تعديل</button> <button class="btn small ghost admin-del-prop" data-id="${p.id}">حذف</button></td></tr>`).join('')}</tbody></table>
            <div style="margin-top:8px"><button class="btn" id="admin-add-prop">إضافة عقار جديد</button></div>
          </div>
        </div>

        <aside>
          <div style="background:#fff;padding:12px;border-radius:12px">
            <h4 style="margin:0 0 8px 0">إدارة الوسطاء</h4>
            <div style="margin-bottom:8px"><button class="btn" id="admin-new-broker">إضافة وسيط</button></div>
            <table class="table"><thead><tr><th>الوسيط</th><th>واتساب</th><th>الحالة</th><th>أفعال</th></tr></thead><tbody id="admin-brokers-rows">${brokers.map(b=>`<tr data-id="${b.id}"><td>${esc(b.username)}</td><td>${esc(b.whatsapp||'-')}</td><td>${b.active? 'مفعل':'موقوف'}</td><td><button class="btn small admin-toggle-broker" data-id="${b.id}">${b.active? 'إيقاف':'تفعيل'}</button> <button class="btn small ghost admin-edit-broker" data-id="${b.id}">تعديل</button></td></tr>`).join('')}</tbody></table>
            <hr style="margin:12px 0;border:none;border-top:1px dashed #eef4ff">
            <h5 style="margin:0 0 8px 0">إعدادات الموقع</h5>
            <div style="display:flex;flex-direction:column;gap:8px">
              <label>رقم واتساب المدير</label>
              <input id="admin-manager-whats" value="${esc(managerWhats)}"/>
              <label>شعار الموقع</label>
              <input type="file" id="admin-logo-file"/>
              <div style="display:flex;gap:8px"><button class="btn" id="save-settings">حفظ</button> <button class="btn ghost" id="close-admin">إغلاق</button></div>
            </div>
          </div>
        </aside>
      </div>
    `;
    showModal(content);

    // attach handlers
    document.getElementById('admin-logout').addEventListener('click', ()=>{ currentUser = null; hideModal(); alert('تم تسجيل الخروج'); });
    document.getElementById('close-admin').addEventListener('click', hideModal);

    // add prop
    document.getElementById('admin-add-prop').addEventListener('click', ()=> openPropForm('create', null));

    // edit / delete props
    $$('.admin-edit-prop').forEach(btn => btn.addEventListener('click', e => openPropForm('edit', e.currentTarget.dataset.id)));
    $$('.admin-del-prop').forEach(btn => btn.addEventListener('click', async e => {
      const id = e.currentTarget.dataset.id;
      if(!confirm('هل تريد حذف هذا العقار؟')) return;
      await db.collection('props').doc(id).delete();
      alert('تم الحذف');
      openAdminUI();
      loadCards();
    }));

    // brokers actions
    document.getElementById('admin-new-broker').addEventListener('click', ()=> openBrokerForm('create', null));
    $$('.admin-toggle-broker').forEach(btn => btn.addEventListener('click', async e => {
      const id = e.currentTarget.dataset.id;
      const ref = db.collection('users').doc(id);
      const snap = await ref.get(); if(!snap.exists) return;
      await ref.update({active: !snap.data().active});
      alert('تم التحديث');
      openAdminUI();
    }));
    $$('.admin-edit-broker').forEach(btn => btn.addEventListener('click', e => openBrokerForm('edit', e.currentTarget.dataset.id)));

    // settings save
    document.getElementById('save-settings').addEventListener('click', async ()=>{
      const newNum = $('#admin-manager-whats').value.trim();
      const file = $('#admin-logo-file').files[0];
      const ref = db.collection('settings').doc('site');
      let logoUrl = null;
      if(file){
        const path = `logos/${Date.now()}_${file.name}`;
        const snap = await storage.ref(path).put(file);
        logoUrl = await snap.ref.getDownloadURL();
      }
      const payload = {};
      if(newNum) payload.managerWhats = newNum;
      if(logoUrl) payload.logo = logoUrl;
      await ref.set(payload, {merge:true});
      managerWhats = newNum || managerWhats;
      if(logoUrl) $('#logo-preview').src = logoUrl;
      $('#manager-number').innerText = managerWhats;
      alert('تم حفظ الإعدادات');
      openAdminUI();
    });
  }

  // ---------- Admin: Prop form (create/edit) ----------
  async function openPropForm(mode='create', propId=null){
    let prop = {};
    if(mode === 'edit' && propId){
      const snap = await db.collection('props').doc(propId).get(); if(!snap.exists) return alert('غير موجود'); prop = snap.data();
    }
    const content = `
      <h3 style="margin-top:0">${mode === 'create' ? 'إنشاء عقار جديد' : 'تعديل عقار'}</h3>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
        <div>
          <label>التصنيف</label>
          <select id="prop-type">${['عمارة','فيلا','شقة','أرض','استراحة'].map(t=>`<option ${prop.type===t? 'selected':''}>${t}</option>`).join('')}</select>
          <label>عنوان العرض</label><input id="prop-title" value="${esc(prop.title||'')}" />
          <label>السعر (أرقام إنجليزية فقط)</label><input id="prop-price" value="${esc(prop.price||'')}" />
          <label>المساحة (م²)</label><input id="prop-area" value="${esc(prop.area||'')}" />
        </div>
        <div>
          <label>المنطقة</label>
          <select id="prop-region"><option ${prop.region==='شمال الطائف'?'selected':''}>شمال الطائف</option><option ${prop.region==='جنوب الطائف'?'selected':''}>جنوب الطائف</option><option ${prop.region==='شرق الطائف'?'selected':''}>شرق الطائف</option><option ${prop.region==='غرب الطائف'?'selected':''}>غرب الطائف</option></select>
          <label>الحي/المنطقة</label><input id="prop-neighborhood" value="${esc(prop.neighborhood||'')}" />
          <label>الصور (أقصى 5)</label><input type="file" id="prop-images" multiple accept="image/*" />
          <div class="images-preview" id="prop-images-preview">${(prop.images||[]).map(u=>`<div class="img-thumb"><img src="${esc(u)}"/></div>`).join('')}</div>
        </div>
      </div>
      <div style="margin-top:8px">
        <label>هل يوجد صك؟</label>
        <select id="prop-sak"><option value="yes" ${prop.sak? 'selected':''}>نعم</option><option value="no" ${!prop.sak? 'selected':''}>لا</option></select>
        <label style="margin-top:8px">هل يقبل البنك؟</label>
        <select id="prop-bank"><option ${prop.bankAccepted? 'selected':''}>نعم</option><option ${!prop.bankAccepted? 'selected':''}>لا</option></select>
        <label style="margin-top:8px">الوصف</label>
        <textarea id="prop-desc" rows="4">${esc(prop.desc||'')}</textarea>
      </div>
      <div style="display:flex;gap:8px;margin-top:12px">
        <button class="btn" id="save-prop">${mode === 'create' ? 'نشر العقار' : 'حفظ التعديل'}</button>
        <button class="btn ghost" id="cancel-prop">إلغاء</button>
      </div>
    `;
    showModal(content);

    // preview images on select
    $('#prop-images').addEventListener('change', (e)=>{
      const files = Array.from(e.target.files).slice(0,5);
      const preview = $('#prop-images-preview'); preview.innerHTML = '';
      files.forEach(f=>{
        const url = URL.createObjectURL(f);
        const el = document.createElement('div'); el.className = 'img-thumb'; el.innerHTML = `<img src="${url}">`;
        preview.appendChild(el);
      });
    });

    $('#cancel-prop').addEventListener('click', hideModal);

    $('#save-prop').addEventListener('click', async ()=>{
      const payload = {
        type: $('#prop-type').value,
        title: $('#prop-title').value.trim(),
        price: $('#prop-price').value.trim(),
        area: $('#prop-area').value.trim(),
        region: $('#prop-region').value,
        neighborhood: $('#prop-neighborhood').value.trim(),
        sak: $('#prop-sak').value === 'yes',
        bankAccepted: $('#prop-bank').value === 'نعم',
        desc: $('#prop-desc').value.trim(),
        ownerRole: 'admin',
        ownerId: currentUser.id,
        views: 0,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      };
      // upload images then set doc
      const files = Array.from($('#prop-images').files).slice(0,5);
      if(files.length){
        const uploaded = [];
        for(let i=0;i<files.length;i++){
          const file = files[i];
          const path = `props/${Date.now()}_${file.name}`;
          const snap = await storage.ref(path).put(file);
          const url = await snap.ref.getDownloadURL();
          uploaded.push(url);
        }
        payload.images = uploaded;
      } else if(mode === 'edit' && (prop.images||[]).length) {
        payload.images = prop.images;
      } else {
        payload.images = [];
      }

      if(mode === 'create'){
        await db.collection('props').add(payload);
        alert('تم نشر العقار');
      } else {
        await db.collection('props').doc(propId).update(payload);
        alert('تم حفظ التعديلات');
      }
      hideModal(); openAdminUI(); loadCards();
    });
  }

  // ---------- Admin: Broker form (create/edit) ----------
  async function openBrokerForm(mode='create', brokerId=null){
    let broker = {};
    if(mode === 'edit' && brokerId){
      const snap = await db.collection('users').doc(brokerId).get(); if(!snap.exists) return alert('غير موجود'); broker = snap.data();
    }
    const content = `
      <h3 style="margin-top:0">${mode === 'create' ? 'إنشاء حساب وسيط' : 'تعديل حساب وسيط'}</h3>
      <label>اسم المستخدم</label><input id="broker-username" value="${esc(broker.username||'')}" />
      <label style="margin-top:6px">كلمة المرور</label><input id="broker-password" value="${esc(broker.password||'')}" />
      <label style="margin-top:6px">رقم واتساب</label><input id="broker-whatsapp" value="${esc(broker.whatsapp||'')}" />
      <div style="display:flex;gap:8px;margin-top:12px">
        <button class="btn" id="save-broker">${mode === 'create' ? 'إنشاء' : 'حفظ'}</button>
        <button class="btn ghost" id="cancel-broker">إلغاء</button>
      </div>
    `;
    showModal(content);

    $('#cancel-broker').addEventListener('click', hideModal);
    $('#save-broker').addEventListener('click', async ()=>{
      const u = $('#broker-username').value.trim(); const p = $('#broker-password').value.trim(); const w = $('#broker-whatsapp').value.trim();
      if(!u || !p){ alert('ادخل اسم مستخدم وكلمة مرور'); return; }
      if(mode === 'create'){
        await db.collection('users').add({username:u, password:p, role:'broker', active:true, whatsapp:w, createdAt: firebase.firestore.FieldValue.serverTimestamp()});
        alert('تم إنشاء الوسيط');
      } else {
        await db.collection('users').doc(brokerId).update({username:u,password:p,whatsapp:w});
        alert('تم التحديث');
      }
      hideModal(); openAdminUI();
    });
  }

  // ---------- Broker UI ----------
  async function openBrokerUI(){
    const propsSnap = await db.collection('props').where('ownerId','==', currentUser.id).orderBy('createdAt','desc').get();
    const props = []; propsSnap.forEach(d=> props.push({id:d.id,...d.data()}));
    const content = `
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3 style="margin:0">لوحة الوسيط — ${esc(currentUser.username)}</h3>
        <div><button class="btn ghost" id="broker-logout">تسجيل خروج</button></div>
      </div>
      <div style="margin-top:12px;display:grid;grid-template-columns:1fr 320px;gap:12px">
        <div>
          <div style="background:#fff;padding:12px;border-radius:12px">
            <h4 style="margin:0 0 8px 0">عقاراتي</h4>
            <div style="margin-bottom:8px"><button class="btn" id="broker-add-prop">إضافة عقار</button></div>
            <table class="table"><thead><tr><th>العنوان</th><th>المنطقة</th><th>السعر</th><th>أفعال</th></tr></thead><tbody>${props.map(p=>`<tr data-id="${p.id}"><td>${esc(p.title)}</td><td>${esc(p.region)}</td><td>${fmt(p.price)}</td><td><button class="btn small broker-edit" data-id="${p.id}">تعديل</button> <button class="btn small ghost broker-del" data-id="${p.id}">حذف</button></td></tr>`).join('')}</tbody></table>
          </div>
        </div>
        <aside>
          <div style="background:#fff;padding:12px;border-radius:12px">
            <h4 style="margin:0 0 8px 0">الملف الشخصي</h4>
            <div>اسم المستخدم: <b>${esc(currentUser.username)}</b></div>
            <div style="margin-top:8px"><label>رقم واتساب</label><input id="broker-ws" value="${esc(currentUser.whatsapp||'')}" /></div>
            <div style="margin-top:12px;display:flex;gap:8px">
              <button class="btn" id="save-broker-ws">حفظ</button>
              <button class="btn ghost" id="close-broker">إغلاق</button>
            </div>
          </div>
        </aside>
      </div>
    `;
    showModal(content);
    $('#broker-logout').addEventListener('click', ()=>{ currentUser = null; hideModal(); alert('تم تسجيل الخروج'); });
    $('#close-broker').addEventListener('click', hideModal);
    $('#save-broker-ws').addEventListener('click', async ()=>{ const w = $('#broker-ws').value.trim(); await db.collection('users').doc(currentUser.id).update({whatsapp:w}); currentUser.whatsapp = w; alert('تم حفظ رقم الواتساب'); openBrokerUI(); });

    // add prop
    $('#broker-add-prop').addEventListener('click', ()=> openBrokerAddPropForm());

    // edit/delete
    $$('.broker-edit').forEach(btn => btn.addEventListener('click', e => openBrokerEditPropForm(e.currentTarget.dataset.id)));
    $$('.broker-del').forEach(btn => btn.addEventListener('click', async e => {
      const id = e.currentTarget.dataset.id;
      if(!confirm('هل تريد حذف هذا العقار؟')) return;
      await db.collection('props').doc(id).delete();
      alert('تم الحذف'); openBrokerUI(); loadCards();
    }));
  }

  async function openBrokerAddPropForm(){
    const content = `
      <h3 style="margin-top:0">إضافة عقار جديد</h3>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
        <div>
          <label>التصنيف</label><select id="b-prop-type"><option>فيلا</option><option>شقة</option><option>عمارة</option><option>أرض</option><option>استراحة</option></select>
          <label>عنوان العرض</label><input id="b-prop-title" />
          <label>السعر</label><input id="b-prop-price" />
          <label>المساحة</label><input id="b-prop-area" />
        </div>
        <div>
          <label>المنطقة</label><select id="b-prop-region"><option>شمال الطائف</option><option>جنوب الطائف</option><option>شرق الطائف</option><option>غرب الطائف</option></select>
          <label>الحي/المنطقة</label><input id="b-prop-neigh" />
          <label>الصور (أقصى 5)</label><input type="file" id="b-prop-images" multiple accept="image/*" />
          <div class="images-preview" id="b-prop-preview"></div>
        </div>
      </div>
      <div style="margin-top:8px"><label>الصك</label><select id="b-prop-sak"><option value="yes">نعم</option><option value="no">لا</option></select></div>
      <div style="margin-top:8px"><label>الوصف</label><textarea id="b-prop-desc" rows="4"></textarea></div>
      <div style="display:flex;gap:8px;margin-top:12px"><button class="btn" id="b-save-prop">نشر</button><button class="btn ghost" id="b-cancel">إلغاء</button></div>
    `;
    showModal(content);
    $('#b-prop-preview').innerHTML = '';
    $('#b-prop-images').addEventListener('change', (e)=>{
      const files = Array.from(e.target.files).slice(0,5);
      const preview = $('#b-prop-preview'); preview.innerHTML = '';
      files.forEach(f=>{ const url = URL.createObjectURL(f); const el = document.createElement('div'); el.className='img-thumb'; el.innerHTML = `<img src="${url}">`; preview.appendChild(el); });
    });
    $('#b-cancel').addEventListener('click', hideModal);
    $('#b-save-prop').addEventListener('click', async ()=>{
      const payload = {
        type: $('#b-prop-type').value,
        title: $('#b-prop-title').value.trim(),
        price: $('#b-prop-price').value.trim(),
        area: $('#b-prop-area').value.trim(),
        region: $('#b-prop-region').value,
        neighborhood: $('#b-prop-neigh').value.trim(),
        sak: $('#b-prop-sak').value === 'yes',
        bankAccepted: false,
        desc: $('#b-prop-desc').value.trim(),
        ownerRole: 'broker', ownerId: currentUser.id,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(), views:0
      };
      const files = Array.from($('#b-prop-images').files).slice(0,5);
      const uploaded = [];
      for(let f of files){
        const path = `props/${Date.now()}_${f.name}`;
        const snap = await storage.ref(path).put(f);
        const url = await snap.ref.getDownloadURL();
        uploaded.push(url);
      }
      payload.images = uploaded;
      await db.collection('props').add(payload);
      alert('تم النشر'); hideModal(); openBrokerUI(); loadCards();
    });
  }

  async function openBrokerEditPropForm(propId){
    const doc = await db.collection('props').doc(propId).get(); if(!doc.exists) return alert('غير موجود'); const p = doc.data();
    const content = `
      <h3 style="margin-top:0">تعديل عقار</h3>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
        <div>
          <label>التصنيف</label><select id="eb-prop-type">${['عمارة','فيلا','شقة','أرض','استراحة'].map(t=>`<option ${p.type===t? 'selected':''}>${t}</option>`).join('')}</select>
          <label>عنوان العرض</label><input id="eb-prop-title" value="${esc(p.title||'')}" />
          <label>السعر</label><input id="eb-prop-price" value="${esc(p.price||'')}" />
          <label>المساحة</label><input id="eb-prop-area" value="${esc(p.area||'')}" />
        </div>
        <div>
          <label>المنطقة</label><select id="eb-prop-region"><option ${p.region==='شمال الطائف'?'selected':''}>شمال الطائف</option><option ${p.region==='جنوب الطائف'?'selected':''}>جنوب الطائف</option><option ${p.region==='شرق الطائف'?'selected':''}>شرق الطائف</option><option ${p.region==='غرب الطائف'?'selected':''}>غرب الطائف</option></select>
          <label>الحي</label><input id="eb-prop-neigh" value="${esc(p.neighborhood||'')}" />
          <label>الصور (إضافة/استبدال)</label><input type="file" id="eb-prop-images" multiple accept="image/*"/>
          <div class="images-preview" id="eb-prop-preview">${(p.images||[]).map(u=>`<div class="img-thumb"><img src="${esc(u)}"/></div>`).join('')}</div>
        </div>
      </div>
      <div style="margin-top:8px"><label>الصك</label><select id="eb-prop-sak"><option value="yes" ${p.sak? 'selected':''}>نعم</option><option value="no" ${!p.sak? 'selected':''}>لا</option></select></div>
      <div style="margin-top:8px"><label>الوصف</label><textarea id="eb-prop-desc" rows="4">${esc(p.desc||'')}</textarea></div>
      <div style="display:flex;gap:8px;margin-top:12px"><button class="btn" id="eb-save">حفظ</button><button class="btn ghost" id="eb-cancel">إلغاء</button></div>
    `;
    showModal(content);
    $('#eb-prop-images').addEventListener('change', (e)=>{
      const files = Array.from(e.target.files).slice(0,5);
      const prev = $('#eb-prop-preview'); prev.innerHTML = '';
      files.forEach(f=>{ const url = URL.createObjectURL(f); const el = document.createElement('div'); el.className='img-thumb'; el.innerHTML = `<img src="${url}">`; prev.appendChild(el); });
    });
    $('#eb-cancel').addEventListener('click', hideModal);
    $('#eb-save').addEventListener('click', async ()=>{
      const payload = {
        type: $('#eb-prop-type').value,
        title: $('#eb-prop-title').value.trim(),
        price: $('#eb-prop-price').value.trim(),
        area: $('#eb-prop-area').value.trim(),
        region: $('#eb-prop-region').value,
        neighborhood: $('#eb-prop-neigh').value.trim(),
        sak: $('#eb-prop-sak').value === 'yes',
        desc: $('#eb-prop-desc').value.trim()
      };
      const files = Array.from($('#eb-prop-images').files).slice(0,5);
      if(files.length){
        const uploaded = [];
        for(let f of files){
          const path = `props/${Date.now()}_${f.name}`;
          const snap = await storage.ref(path).put(f);
          const url = await snap.ref.getDownloadURL();
          uploaded.push(url);
        }
        payload.images = uploaded;
      }
      await db.collection('props').doc(propId).update(payload);
      alert('تم الحفظ'); hideModal(); openBrokerUI(); loadCards();
    });
  }

  // ---------- init ----------
  (async ()=>{
    await ensureDefaults();
    await loadCards();
  })();
  </script>
</body>
</html>
